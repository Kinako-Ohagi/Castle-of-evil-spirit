#textdomain wesnoth-Castle_of_evil_spirit


####################### マップ構成パーツの変数化

#define MAP_TILE
####################### マップブロックの設計図
	[set_variables]
		name = tile_set
		mode=replace
		[value]
			##### 最終的に反映される地形の設定
			[terracode]
				############# 実際に使用する地形を記録する場所
				tile_str = no
			[/terracode]
			
			###### ブロックの種類リスト。
			[b_type]
				########### コンテナ番号0 項目の説明のみ
				### パーツの種類を示す
				type = room_1
				### 使用ブロック数
				block = 4
				### mother=起点ブロック child=付随ブロック
				mother = 1 # レイアウトのコンテナ番号
				child_1 = 8 # レイアウトのコンテナ番号
				child_2 = 9
				child_3 = 10
				### パーツ形状 position = (y軸のブロック数)_(x軸のブロック数)
				position = 2_2
				### パーツの配置
				m_pos = 1_1
				c1_pos = 1_2
				c2_pos = 2_1
				c3_pos = 2_2
				# layout = 1 # コンテナ番号
			[/b_type]
			[b_type]
				type = room_1
				block = 1
				mother = 20
				size_y = 1
				size_x = 1
				m_pos = 1_1
			[/b_type]
			[b_type]
				type = room_2
				block = 2
				mother = 2
				child_1 = 15
				size_y = 2
				size_x = 1
				m_pos = 1_1
				c1_pos = 2_1
			[/b_type]
			[b_type]
				type = room_3
				block = 2
				mother = 21
				child_1 = 22
				size_y = 1
				size_x = 2
				m_pos = 1_1
				c1_pos = 1_2
			[/b_type]
			[b_type]
				type = room_4
				block = 4
				mother = 3
				child_1 = 11
				child_2 = 7
				child_3 = 16
				size_y = 2
				size_x = 2
				m_pos = 1_1
				c1_pos = 1_2
				c2_pos = 2_1
				c3_pos = 2_2
			[/b_type]
			[b_type]
				type = room_5
				block = 6
				mother = 3
				child_1 = 1
				child_2 = 11
				child_3 = 7
				child_4 = 1
				child_5 = 16
				size_y = 2
				size_x = 3
				m_pos = 1_1
				c1_pos = 1_2
				c2_pos = 1_3
				c3_pos = 2_1
				c4_pos = 2_2
				c5_pos = 2_3
			[/b_type]
			[b_type]
				type = room_6
				block = 9
				mother = 4
				child_1 = 2
				child_2 = 12
				child_3 = 1
				child_4 = 1
				child_5 = 1
				child_6 = 8
				child_7 = 15
				child_8 = 17
				size_y = 3
				size_x = 3
				m_pos = 1_1
				c1_pos = 1_2
				c2_pos = 1_3
				c3_pos = 2_1
				c4_pos = 2_2
				c5_pos = 2_3
				c6_pos = 3_1
				c7_pos = 3_2
				c8_pos = 3_3
			[/b_type]
			[b_type]
				type = room_7
				block = 8
				mother = 3
				child_1 = 1
				child_2 = 1
				child_3 = 11
				child_4 = 7
				child_5 = 1
				child_6 = 1
				child_7 = 16
				size_y = 2
				size_x = 4
				m_pos = 1_1
				c1_pos = 1_2
				c2_pos = 1_3
				c3_pos = 1_4
				c4_pos = 2_1
				c5_pos = 2_2
				c6_pos = 2_3
				c7_pos = 2_4
			[/b_type]
			[b_type]
				type = room_8
				block = 12
				mother = 5
				child_1 = 3
				child_2 = 11
				child_3 = 13
				child_4 = 1
				child_5 = 1
				child_6 = 1
				child_7 = 1
				child_8 = 9
				child_9 = 7
				child_10 = 16
				child_11 = 18
				size_y = 3
				size_x = 4
				m_pos = 1_1
				c1_pos = 1_2
				c2_pos = 1_3
				c3_pos = 1_4
				c4_pos = 2_1
				c5_pos = 2_2
				c6_pos = 2_3
				c7_pos = 2_4
				c8_pos = 3_1
				c9_pos = 3_2
				c10_pos = 3_3
				c11_pos = 3_4
			[/b_type]
			[b_type]
				type = room_9
				block = 15
				mother = 5
				child_1 = 3
				child_2 = 1
				child_3 = 11
				child_4 = 13
				child_5 = 1
				child_6 = 1
				child_7 = 1
				child_8 = 1
				child_9 = 1
				child_10 = 9
				child_11 = 7
				child_12 = 1
				child_13 = 16
				child_14 = 18
				size_y = 3
				size_x = 5
				m_pos = 1_1
				c1_pos = 1_2
				c2_pos = 1_3
				c3_pos = 1_4
				c4_pos = 1_5
				c5_pos = 2_1
				c6_pos = 2_2
				c7_pos = 2_3
				c8_pos = 2_4
				c9_pos = 2_5
				c10_pos = 3_1
				c11_pos = 3_2
				c12_pos = 3_3
				c13_pos = 3_4
				c14_pos = 3_5
			[/b_type]
			[b_type]
				type = room_10
				block = 20
				mother = 5
				child_1 = 3
				child_2 = 1
				child_3 = 11
				child_4 = 13
				child_5 = 1
				child_6 = 1
				child_7 = 1
				child_8 = 1
				child_9 = 1
				child_10 = 1
				child_11 = 1
				child_12 = 1
				child_13 = 1
				child_14 = 1
				child_15 = 9
				child_16 = 7
				child_17 = 1
				child_18 = 16
				child_19 = 18
				size_y = 4
				size_x = 5
				m_pos = 1_1
				c1_pos = 1_2
				c2_pos = 1_3
				c3_pos = 1_4
				c4_pos = 1_5
				c5_pos = 2_1
				c6_pos = 2_2
				c7_pos = 2_3
				c8_pos = 2_4
				c9_pos = 2_5
				c10_pos = 3_1
				c11_pos = 3_2
				c12_pos = 3_3
				c13_pos = 3_4
				c14_pos = 3_5
				c15_pos = 4_1
				c16_pos = 4_2
				c17_pos = 4_3
				c18_pos = 4_4
				c19_pos = 4_5
			[/b_type]
			[b_type]
				type = room_11
				block = 18
				mother = 23
				child_1 = 5
				child_2 = 3
				child_3 = 11
				child_4 = 13
				child_5 = 23
				child_6 = 21
				child_7 = 1
				child_8 = 1
				child_9 = 1
				child_10 = 1
				child_11 = 22
				child_12 = 23
				child_13 = 9
				child_14 = 7
				child_15 = 16
				child_16 = 18
				child_17 = 23
				size_y = 3
				size_x = 6
				m_pos = 1_1
				c1_pos = 1_2
				c2_pos = 1_3
				c3_pos = 1_4
				c4_pos = 1_5
				c5_pos = 1_6
				c6_pos = 2_1
				c7_pos = 2_2
				c8_pos = 2_3
				c9_pos = 2_4
				c10_pos = 2_5
				c11_pos = 2_6
				c12_pos = 3_1
				c13_pos = 3_2
				c14_pos = 3_3
				c15_pos = 3_4
				c16_pos = 3_5
				c17_pos = 3_6
			[/b_type]
			#### 通路のブロックタイプ
			[b_type]
				type = pathway
				block = 1
				mother = 23
				position = 1_1
				m_pos = 1_1
			[/b_type]
			
			###### ブロックのレイアウト
			[layout]
				### X座標に対するY座標
				x_1 = 2_4 # x=1 y=2,3,4
				x_2 = 1_4
				x_3 = 1_4
				x_4 = 1_3
			[/layout]
			[layout] ##### コンテナ1
				x_1 = 1_4
				x_2 = 1_4
				x_3 = 1_4
				x_4 = 1_4
			[/layout]
			[layout] ## 2
				x_1 = 2_4
				x_2 = 1_4
				x_3 = 1_4
				x_4 = 1_4
			[/layout]
			[layout] ## 3
				x_1 = 3_4
				x_2 = 2_4
				x_3 = 2_4
				x_4 = 1_4
			[/layout]
			[layout] ## 4
				x_1 = 4
				x_2 = 3_4
				x_3 = 3_4
				x_4 = 2_4
			[/layout]
			[layout] ## 5
				x_1 = 0
				x_2 = 4
				x_3 = 4
				x_4 = 3_4
			[/layout]
			[layout] ## 6
				x_1 = 0
				x_2 = 0
				x_3 = 0
				x_4 = 4
			[/layout]
			[layout] ## 7
				x_1 = 1_3
				x_2 = 1_3
				x_3 = 1_4
				x_4 = 1_4
			[/layout]
			[layout] ## 8
				x_1 = 1_2
				x_2 = 1_2
				x_3 = 1_3
				x_4 = 1_3
			[/layout]
			[layout] ## 9
				x_1 = 1
				x_2 = 1
				x_3 = 1_2
				x_4 = 1_2
			[/layout]
			[layout] ## 10
				x_1 = 0
				x_2 = 0
				x_3 = 1
				x_4 = 1
			[/layout]
			[layout] ## 11
				x_1 = 1_4
				x_2 = 1_4
				x_3 = 2_4
				x_4 = 2_4
			[/layout]
			[layout] ## 12
				x_1 = 2_4
				x_2 = 2_4
				x_3 = 3_4
				x_4 = 3_4
			[/layout]
			[layout] ## 13
				x_1 = 3_4
				x_2 = 3_4
				x_3 = 4
				x_4 = 4
			[/layout]
			[layout] ## 14
				x_1 = 4
				x_2 = 4
				x_3 = 0
				x_4 = 0
			[/layout]
			[layout] ## 15
				x_1 = 1_4
				x_2 = 1_4
				x_3 = 1_4
				x_4 = 1_3
			[/layout]
			[layout] ## 16
				x_1 = 1_4
				x_2 = 1_3
				x_3 = 1_3
				x_4 = 1_2
			[/layout]
			[layout] ## 17
				x_1 = 1_3
				x_2 = 1_2
				x_3 = 1_2
				x_4 = 1
			[/layout]
			[layout] ## 18
				x_1 = 1_2
				x_2 = 1
				x_3 = 1
				x_4 = 0
			[/layout]
			[layout] ## 19
				x_1 = 1
				x_2 = 0
				x_3 = 0
				x_4 = 0
			[/layout]
			[layout] ## 20
				x_1 = 2_4
				x_2 = 1_4
				x_3 = 1_4
				x_4 = 1_3
			[/layout]
			[layout] ## 21
				x_1 = 3
				x_2 = 2_3
				x_3 = 2_4
				x_4 = 1_4
			[/layout]
			[layout] ## 22
				x_1 = 1_4
				x_2 = 1_3
				x_3 = 2_3
				x_4 = 2
			[/layout]
			[layout] ## 23
				x_1 = 0
				x_2 = 0
				x_3 = 0
				x_4 = 0
			[/layout]
			
			###### 通路のレイアウト
			[pathway] ## 0
				type = e_w
				x_1 = 3
				x_2 = 3
				x_3 = 3
				x_4 = 2
			[/pathway]
			[pathway]
				type = n_s
				x_1 = 0
				x_2 = 1_4
				x_3 = 0
				x_4 = 0
			[/pathway]
			[pathway]
				type = e_n
				x_1 = 2
				x_2 = 1
				x_3 = 0
				x_4 = 0
			[/pathway]
			[pathway]
				type = e_s
				x_1 = 2
				x_2 = 2_4
				x_3 = 0
				x_4 = 0
			[/pathway]
			[pathway]
				type = n_w
				x_1 = 0
				x_2 = 1
				x_3 = 2
				x_4 = 2
			[/pathway]
			[pathway]
				type = s_w
				x_1 = 0
				x_2 = 3_4
				x_3 = 3
				x_4 = 2
			[/pathway] ## 5
			[pathway]
				type = 4e
				x_1 = 2
				x_2 = 2
				x_3 = 0
				x_4 = 0
			[/pathway] ## 6
			[pathway]
				type = 5e
				x_1 = 3
				x_2 = 3
				x_3 = 0
				x_4 = 0
			[/pathway]
			[pathway]
				type = 6e
				x_1 = 3
				x_2 = 3
				x_3 = 4
				x_4 = 0
			[/pathway]
			[pathway]
				type = 9e
				x_1 = 2
				x_2 = 0
				x_3 = 0
				x_4 = 0
			[/pathway]
			[pathway]
				type = 10e
				x_1 = 2
				x_2 = 1
				x_3 = 0
				x_4 = 0
			[/pathway] ## 10
			[pathway]
				type = 12w_17w
				x_1 = 0
				x_2 = 0
				x_3 = 0
				x_4 = 2
			[/pathway]
			[pathway]
				type = 13w
				x_1 = 0
				x_2 = 0
				x_3 = 3
				x_4 = 2
			[/pathway]
			[pathway]
				type = 14w
				x_1 = 0
				x_2 = 3
				x_3 = 3
				x_4 = 2
			[/pathway]
			[pathway]
				type = 18w
				x_1 = 0
				x_2 = 0
				x_3 = 2
				x_4 = 2
			[/pathway]
			[pathway]
				type = 19w
				x_1 = 0
				x_2 = 1
				x_3 = 2
				x_4 = 2
			[/pathway] ## 15
			[pathway]
				type = 3n_12n_21n
				x_1 = 0
				x_2 = 1
				x_3 = 0
				x_4 = 0
			[/pathway]
			[pathway]
				type = 4n_13n
				x_1 = 0
				x_2 = 1_2
				x_3 = 0
				x_4 = 0
			[/pathway]
			[pathway]
				type = 5n_14n
				x_1 = 0
				x_2 = 1_3
				x_3 = 0
				x_4 = 0
			[/pathway]
			[pathway]
				type = 6n
				x_1 = 0
				x_2 = 1_3
				x_3 = 4
				x_4 = 0
			[/pathway]
			[pathway]
				type = 7s_16s_21s_22s
				x_1 = 0
				x_2 = 4
				x_3 = 0
				x_4 = 0
			[/pathway] ## 20
			[pathway]
				type = 8s_17s
				x_1 = 0
				x_2 = 3_4
				x_3 = 0
				x_4 = 0
			[/pathway]
			[pathway]
				type = 9s_18s
				x_1 = 0
				x_2 = 2_4
				x_3 = 0
				x_4 = 0
			[/pathway]
			[pathway]
				type = 10s_19s
				x_1 = 0
				x_2 = 1_4
				x_3 = 0
				x_4 = 0
			[/pathway] ## 23
		[/value]
	[/set_variables]
#enddef


####################### 壁塗りつぶしマクロ
#define MAP_WALL_1 SIZE_Y SIZE_X CODE
	#### SIZE_Y:Y座標の大きさ
	#### SIZE_X:X座標の大きさ
	#### CODE 歩けない森：Gg^Fpu,Gg^^Ftru,Gg^^Fdsu,Gg^^Fdfu,Gg^^Fdwu　
	[for]
		variable = i
		start = 1
		end = "$({SIZE_X}+1)"
		step = 1
		[do]
			[terrain]
				terrain = {CODE}
				x= 0,"$({SIZE_X}*4+5)"
				y= 0-"$({SIZE_Y}*4+5)",0-"$({SIZE_Y}*4+5)"
			[/terrain]
			[terrain]
				terrain = {CODE}
				x= "$($i|*4-3)","$($i|*4-2)","$($i|*4-1)","$($i|*4)"
				y= 0-"$({SIZE_Y}*4+5)",0-"$({SIZE_Y}*4+5)",0-"$({SIZE_Y}*4+5)",0-"$({SIZE_Y}*4+5)"
			[/terrain]
		[/do]
	[/for]
#enddef

#define MAP_WALL_2 SIZE_Y SIZE_X CODE_A CODE_B
	#### SIZE_Y:Y座標の大きさ
	#### SIZE_X:X座標の大きさ
	######### 最初に周囲を塗り潰す
	[terrain]
		terrain = {CODE_B}
		x= 0,"$({SIZE_X}*4+5)",1-"$({SIZE_X}*4+4)",1-"$({SIZE_X}*4+4)"
		y= 0-"$({SIZE_Y}*4+5)",0-"$({SIZE_Y}*4+5)",0,"$({SIZE_Y}*4+5)"
	[/terrain]
	######### 他の部分をランダム塗りつぶし
	[for]
		variable = i
		start = 1
		end = "$({SIZE_X}*4+4)"
		step = 1
		[do]
			[for]
				variable = l
				start = 1
				end = "$({SIZE_Y}*4+4)"
				step = 1
				[do]
					[set_variable]
						name = terracode
						rand = {CODE_A}
					[/set_variable]
					[terrain]
						terrain = $terracode|
						x= $i|
						y= $l|
					[/terrain]
				[/do]
			[/for]
		[/do]
	[/for]
#enddef

##### 壁地形：水
#define CODE_WATER_A
Wot,Wot,Wot,Wot,Wot,Wot,Wwt,Wwt,Wwrt#enddef
#define CODE_WATER_B
Wot#enddef

##### 壁地形：溶岩
#define CODE_LAVA_A
Ql,Ql,Qlf#enddef
#define CODE_LAVA_B
Ql#enddef

##### 壁地形：裂け目
#define CODE_CHASM_A
Qxu,Qxu,Qxe#enddef
#define CODE_CHASM_B
Qxu#enddef

##### 壁地形：洞窟
#define CODE_CAVE_A
Xu,Xu,Xu,Xu,Xue#enddef
#define CODE_CAVE_B
Xu#enddef

##### 壁地形：鉱山1
#define CODE_MINE1_A
Xom,Xom,Xuc,Xue#enddef
#define CODE_MINE1_B
Xom#enddef

##### 壁地形：鉱山2
#define CODE_MINE2_A
Xuc,Xuc,Xuc,Xue#enddef
#define CODE_MINE2_B
Xuc#enddef

##### 壁地形：石壁1
#define CODE_WALL1_A
Xoc,Xoc,Xoc,Xoi#enddef
#define CODE_WALL1_B
Xoc#enddef

##### 壁地形：石壁2
#define CODE_WALL2_A
Xoc,Xoc,Xoc,Xos#enddef
#define CODE_WALL2_B
Xoc#enddef

##### 壁地形：石壁3
#define CODE_WALL3_A
Xos,Xos,Xos,Xos,Xos,Xos,Xoc#enddef
#define CODE_WALL3_B
Xos#enddef




####################### 部屋、階段、通路の地形リスト

################# 部屋
#### 草原タイプ
#define ROOMCODE_G
Gg,Gg,Gs^Es,Gs,Gs^Fms,Gs,Gd,Gll,Gg,Gg,Gs^Fms,Gs,Gs,Gs,Gd^Es,Gll,Rb,Re,Rd,Rd,Dd,Ds,Sm,Gg^Dr,Re^Dr,Gd^Gvs,Ce#enddef
#### 水辺タイプ
#define ROOMCODE_W
Wwf,Wwf,Gg,Gg^Es,Gs,Gd,Gll,Rb,Re,Rd^Es,Rd,Dd,Ds,Ds,Ds^Ftd,Sm,Ss,Dd^Do,Dd^Dc,Ce#enddef
#### 屋内板張タイプ
#define ROOMCODE_R1
Iwr,Iwr,Iwr,Iwr,Iwr,Iwr,Ior,Ur,Cud#enddef
#### 屋内砂利タイプ
#define ROOMCODE_R2
Rrc,Rrc,Rrc,Rrc,Rrc,Rrc,Rr,Rr,Rp,Cud#enddef
#### 洞窟浅めタイプ
#define ROOMCODE_C1
Ur,Ur,Ur,Ur,Ur,Ur,Urb,Urb,Urb,Uue,Uue,Uu^Ii,Ur^Ii,Ur^Uf,Ur^Ufi,Ur^Esd,Ur^Es,Ur^Dr,Urb^Ii,Urb^Esd,Urb^Es,Uue^Uf,Uue^Ii,Uu^Ufi,Uh,Uh,Cud#enddef
#### 洞窟深めタイプ
#define ROOMCODE_C2
Ur,Ur,Ur,Ur,Ur,Ur,Urb,Uu,Uu,Uue,Uue,Uu^Ii,Ur^Ii,Ur^Uf,Ur^Ufi,Ur^Esd,Ur^Es,Ur^Dr,Uu^Ii,Uh^Esd,Uh^Es,Uue^Uf,Uue^Ii,Uu^Ufi,Uh,Uh,Cud#enddef

################### 通路リスト
#### 地上用：草地,Gg 地面,Rd 石畳,Rrc 古い石畳,Rp　砂地,Ds　
#### 屋内用：板張,Iwr　古い板張,Ior　石の床,Irs　暗い石の床,Urb
#### 洞窟用：暗い石の床,Urb　地面,Ur　荒れた地面,Uue　暗い地面,Rb　

################### 階段リスト
#### 登り：^Yd1,^Yd2,^Yd19,^Yd20
#### 下り：^Yd4,^Yd5,^Yd17,^Yd18,(穴)^Yd21


##################################################################### 階段作成マクロ
#####################################################################
#####################################################################

####### 通常の階段
#define STAIR_A TYPE SIZE_X SIZE_Y
#### TYPE:階段の地形コード

[if]
	[variable]
		name = map_block.rooms.room_num
		greater_than = 1
	[/variable]
	[then]
	######### 階段を作る部屋を選ぶ
	[set_variable]
		name = map_block.rooms.stairs_room
		rand = 1..$map_block.rooms.room_num|
	[/set_variable]
	#### 部屋のパス
	[set_variable]
		name = stairs_room
		value = $cont_$map_block.rooms.stairs_room||
	[/set_variable]
	##### 階段のブロック位置を決める
	[switch]
		variable = $stairs_room|.size_x
		[case]
			value = 1
			[set_variable]
				name = map_block.rooms.stairs_x_b
				value = 1
			[/set_variable]
		[/case]
		[case]
			value = 6
			[set_variable]
				name = map_block.rooms.stairs_x_b
				rand = 2..4
			[/set_variable]
		[/case]
		[else]
			[set_variable]
				name = map_block.rooms.stairs_x_b
				rand = 1..$$stairs_room|.size_x|
			[/set_variable]
		[/else]
	[/switch]
	[if]
		[variable]
			name = $stairs_room|.size_y
			not_equals = 1
		[/variable]
		[then]
			[set_variable]
				name = map_block.rooms.stairs_y_b
				rand = 1..$$stairs_room|.size_y|
			[/set_variable]
		[/then]
		[else]
			[set_variable]
				name = map_block.rooms.stairs_y_b
				value = 1
			[/set_variable]
		[/else]
	[/if]
	[set_variable]
		name = map_block.stairs_posi_x
		value = "$("$map_block.rooms.stairs_x_b|"+"$$stairs_room|.x_s|"-1)"
	[/set_variable]
	[set_variable]
		name = map_block.stairs_posi_y
		value = "$("$map_block.rooms.stairs_y_b|"+"$$stairs_room|.y_s|"-1)"
	[/set_variable]
	###### 部屋のレイアウトを記録
	[set_variable]
		name = map_block.stairs_layout
		value = $map_block.b_y[$map_block.stairs_posi_y|].b_x[$map_block.stairs_posi_x|].layout|
	[/set_variable]
	###### 最終座標を決める
	[for]
		variable = i
		start = 1
		end = 4
		step = 1
		[do]
			[if]
				[variable]
					name = $tile_set.layout[$map_block.stairs_layout|].x_$map_block.rooms.stairs_y_b|
					not_equals = 0
				[/variable]
				[then]
					[set_variables]
						name = map_block.rooms.stairs_x_num
						mode = append
						[value]
							num = $i|
						[/value]
					[/set_variables]
				[/then]
			[/if]
		[/do]
	[/for]
	[set_variable]
		name = map_block.rooms.x_num
		[join]
			variable = map_block.rooms.stairs_x_num
			key = num
			separator = ","
		[/join]
	[/set_variable]
	[set_variable]
		name = map_block.rooms.stairs_x
		rand = 1..$map_block.rooms.x_num|
	[/set_variable]
	
	
	[switch]
		variable = tile_set.layout[$map_block.stairs_layout|].x_$map_block.rooms.stairs_x|
		[case]
			value = 1,2,3,4
			[set_variable]
				name = map_block.rooms.stairs_y
				value = $tile_set.layout[$map_block.stairs_layout|].x_$map_block.rooms.stairs_x||
			[/set_variable]
		[/case]
		[case]
			value = 1_2
			[set_variable]
				name = map_block.rooms.stairs_y
				rand = 1,2
			[/set_variable]
		[/case]
		[case]
			value = 1_3
			[set_variable]
				name = map_block.rooms.stairs_y
				rand = 1..3
			[/set_variable]
		[/case]
		[case]
			value = 1_4
			[set_variable]
				name = map_block.rooms.stairs_y
				rand = 1..4
			[/set_variable]
		[/case]
		[case]
			value = 2_3
			[set_variable]
				name = map_block.rooms.stairs_y
				rand = 2,3
			[/set_variable]
		[/case]
		[case]
			value = 2_4
			[set_variable]
				name = map_block.rooms.stairs_y
				rand = 2..4
			[/set_variable]
		[/case]
		[case]
			value = 3_4
			[set_variable]
				name = map_block.rooms.stairs_y
				rand = 3,4
			[/set_variable]
		[/case]
	[/switch]
	
	[set_variable]
		name = map_block.stairs_x
		value = "$("$map_block.stairs_posi_x|"*4+"$map_block.rooms.stairs_x|")"
	[/set_variable]
	[set_variable]
		name = map_block.stairs_y
		value = "$("$map_block.stairs_posi_y|"*4+"$map_block.rooms.stairs_y|")"
	[/set_variable]
	
	##### 階段描画
	[terrain]
		terrain = {TYPE}
		layer = overlay
		x= $map_block.stairs_x|
		y= $map_block.stairs_y|
	[/terrain]
	[/then]
	
######### 大部屋用
	##### 階段位置を決める
	[else]
	[set_variable]
		name = map_block.rooms.stairs_x
		rand = 5.."$({SIZE_X}*4)"
	[/set_variable]
	[set_variable]
		name = map_block.rooms.stairs_y
		rand = 5.."$({SIZE_Y}*4)"
	[/set_variable]
	##### 階段描画
	[terrain]
		terrain = {TYPE}
		layer = overlay
		x= $map_block.rooms.stairs_x|
		y= $map_block.rooms.stairs_y|
	[/terrain]
	[/else]
[/if]
#enddef


####### 脱出路タイプ
#define STAIR_B TYPE SIZE_X SIZE_Y
	###### どの方角に脱出路を作るか決める
	[set_variable]
		name = map_block.rooms.exit_num
		rand = 1,2
	[/set_variable]
	########## 大部屋分岐
	[if]
		[variable]
			name = map_block.rooms.room_num
			greater_than = 1
		[/variable]
		[then]
			###### 座標を決める準備
			[switch]
				variable = map_block.rooms.exit_num
				[case]
					value = 1
					###### 北
					[set_variable]
						name = switch_1
						value = y_s
					[/set_variable]
					[set_variable]
						name = switch_2
						value = greater_than
					[/set_variable]
					[set_variable]
						name = switch_3
						value = x_s
					[/set_variable]
					[set_variables]
						name = map_block.rooms.exit
						mode=append
						[value]
							out = no
							rank = 1
						[/value]
					[/set_variables]
					[set_variables]
						name = map_block.rooms.exit
						mode=append
						[value]
							y_s = {SIZE_Y}
							x_s = {SIZE_X}
							y_l = 0
							x_l = 0
						[/value]
					[/set_variables]
				[/case]
				[case]
					value = 2
					###### 南
					[set_variable]
						name = switch_1
						value = y_l
					[/set_variable]
					[set_variable]
						name = switch_2
						value = less_than
					[/set_variable]
					[set_variable]
						name = switch_3
						value = x_l
					[/set_variable]
					[set_variables]
						name = map_block.rooms.exit
						mode=append
						[value]
							out = no
							rank = 1
						[/value]
					[/set_variables]
					[set_variables]
						name = map_block.rooms.exit
						mode=append
						[value]
							y_s = {SIZE_Y}
							x_s = {SIZE_X}
							y_l = 0
							x_l = 0
						[/value]
					[/set_variables]
				[/case]
			[/switch]
			##### 近い部屋を探す
			
			[for]
				variable = exr
				start = 1
				end = $map_block.rooms.room_num|
				step = 1
				[do]
					[set_variable]
						name = map_block.rooms.exit[0].out
						value = no
					[/set_variable]
					[while]
						[variable]
							name = map_block.rooms.exit.out
							equals = no
						[/variable]
						[do]
							[switch]
								variable = map_block.rooms.exit[$map_block.rooms.exit[0].rank|].$switch_1|
								[case]
									value = $$cont_$exr||.$switch_1||
									[set_variable]
										name = map_block.rooms.exit[0].rand
										rand = 0,1
									[/set_variable]
									[set_variables]
										name = map_block.rooms.exit["$("$map_block.rooms.exit[0].rank|"+"$map_block.rooms.exit[0].rand|")"]
										mode=insert
										[value]
											start_x = $$cont_$exr||.$switch_3||
											start_y = $$cont_$exr||.$switch_1||
											y_s = $$cont_$exr||.y_s|
											x_s = $$cont_$exr||.x_s|
											y_l = $$cont_$exr||.y_l|
											x_l = $$cont_$exr||.x_l|
											room = $exr|
										[/value]
									[/set_variables]
									[set_variable]
										name = map_block.rooms.exit[0].rank
										value = 1
									[/set_variable]
									[set_variable]
										name = map_block.rooms.exit[0].out
										add = yes
									[/set_variable]
								[/case]
								[else]
									[if]
										[variable]
											name = switch_2
											equals = greater_than
										[/variable]
										[variable]
											name = "map_block.rooms.exit[$map_block.rooms.exit[0].rank|].$switch_1|"
											greater_than = $$cont_$exr||.$switch_1|
										[/variable]
										[then]
											[set_variables]
												name = map_block.rooms.exit["$map_block.rooms.exit[0].rank|"]
												mode=insert
												[value]
													start_x = $$cont_$exr||.$switch_3||
													start_y = $$cont_$exr||.$switch_1||
													y_s = $$cont_$exr||.y_s|
													x_s = $$cont_$exr||.x_s|
													y_l = $$cont_$exr||.y_l|
													x_l = $$cont_$exr||.x_l|
													room = $exr|
												[/value]
											[/set_variables]
											[set_variable]
												name = map_block.rooms.exit[0].rank
												value = 1
											[/set_variable]
											[set_variable]
												name = map_block.rooms.exit[0].out
												add = yes
											[/set_variable]
										[/then]
										[elseif]
											[variable]
												name = switch_2
												equals = less_than
											[/variable]
											[variable]
												name = "map_block.rooms.exit[$map_block.rooms.exit[0].rank|].$switch_1|"
												less_than = $$cont_$exr||.$switch_1|
											[/variable]
											[then]
											[set_variables]
												name = map_block.rooms.exit["$map_block.rooms.exit[0].rank|"]
												mode=insert
												[value]
													start_x = $$cont_$exr||.$switch_3||
													start_y = $$cont_$exr||.$switch_1||
													y_s = $$cont_$exr||.y_s|
													x_s = $$cont_$exr||.x_s|
													y_l = $$cont_$exr||.y_l|
													x_l = $$cont_$exr||.x_l|
													room = $exr|
												[/value]
											[/set_variables]
											[set_variable]
												name = map_block.rooms.exit[0].rank
												value = 1
											[/set_variable]
											[set_variable]
												name = map_block.rooms.exit[0].out
												add = yes
											[/set_variable]
											[/then]
										[/elseif]
										[else]
											[set_variable]
												name = map_block.rooms.exit[0].rank
												add = 1
											[/set_variable]
										[/else]
									[/if]
								[/else]
							[/switch]
						[/do]
					[/while]
				[/do]
			[/for]
			#### 近いブロックのパス
			[set_variable]
				name = outroom
				value = $map_block."$map_block.rooms.exit[1].start_y|_$map_block.rooms.exit[1].start_x|"|
			[/set_variable]
			#### 出口の位置を決める
			[if]
				[variable]
					name = map_block.rooms.exit_num
					equals = 1
				[/variable]
				[then]
					[switch]
						variable = $outroom|.layout
						[case]
							value = 1,2,11,20,22
							[set_variable]
								name = outroom_x
								value = "$($$outroom|.start_x|+2)"
							[/set_variable]
							[set_variable]
								name = outroom_y
								value = "$($$outroom|.start_y|-2)"
							[/set_variable]
							[set_variable]
								name = outroom_sty
								value = 0-$$outroom|.start_y|
							[/set_variable]
						[/case]
						[case]
							value = 3,21
							[set_variable]
								name = outroom_x
								value = "$($$outroom|.start_x|+4)"
							[/set_variable]
							[set_variable]
								name = outroom_y
								value = "$($$outroom|.start_y|-2)"
							[/set_variable]
							[set_variable]
								name = outroom_sty
								value = 0-$$outroom|.start_y|
							[/set_variable]
						[/case]
						[case]
							value = 4,12
							[set_variable]
								name = outroom_x
								value = "$($$outroom|.start_x|+3)"
							[/set_variable]
							[set_variable]
								name = outroom_y
								value = "$($$outroom|.start_y|-2)"
							[/set_variable]
							[set_variable]
								name = outroom_sty
								value = 0-"$($$outroom|.start_y|+2)"
							[/set_variable]
						[/case]
						[case]
							value = 5,13
							[set_variable]
								name = outroom_x
								value = "$($$outroom|.start_x|+3)"
							[/set_variable]
							[set_variable]
								name = outroom_y
								value = "$($$outroom|.start_y|-2)"
							[/set_variable]
							[set_variable]
								name = outroom_sty
								value = 0-"$($$outroom|.start_y|+3)"
							[/set_variable]
						[/case]
						[case]
							value = 6,14
							[set_variable]
								name = outroom_x
								value = "$($$outroom|.start_x|+3)"
							[/set_variable]
							[set_variable]
								name = outroom_y
								value = "$($$outroom|.start_y|-2)"
							[/set_variable]
							[set_variable]
								name = outroom_sty
								value = 0-"$($$outroom|.start_y|+4)"
							[/set_variable]
						[/case]
						[case]
							value = 23
							[set_variable]
								name = outroom_x
								value = "$($$outroom|.start_x|+2)"
							[/set_variable]
							[set_variable]
								name = outroom_y
								value = "$($$outroom|.start_y|-2)"
							[/set_variable]
							[set_variable]
								name = outroom_sty
								value = 0-"$($$outroom|.start_y|+5)"
							[/set_variable]
						[/case]
					[/switch]
				[/then]
				[else]
					[switch]
						variable = $outroom|.layout
						[case]
							value = 1,7,15,20,21
							[set_variable]
								name = outroom_x
								value = "$($$outroom|.start_x|+3)"
							[/set_variable]
							[set_variable]
								name = outroom_y
								value = "$($$outroom|.start_y|+6)"
							[/set_variable]
							[set_variable]
								name = outroom_sty
								value = "$($$outroom|.start_y|+5)"-"$({SIZE_Y}*4+9)"
							[/set_variable]
						[/case]
						[case]
							value = 16,22
							[set_variable]
								name = outroom_x
								value = "$($$outroom|.start_x|+1)"
							[/set_variable]
							[set_variable]
								name = outroom_y
								value = "$($$outroom|.start_y|+6)"
							[/set_variable]
							[set_variable]
								name = outroom_sty
								value = "$($$outroom|.start_y|+5)"-"$({SIZE_Y}*4+9)"
							[/set_variable]
						[/case]
						[case]
							value = 8,17
							[set_variable]
								name = outroom_x
								value = "$($$outroom|.start_x|+2)"
							[/set_variable]
							[set_variable]
								name = outroom_y
								value = "$($$outroom|.start_y|+6)"
							[/set_variable]
							[set_variable]
								name = outroom_sty
								value = "$($$outroom|.start_y|+3)"-"$({SIZE_Y}*4+9)"
							[/set_variable]
						[/case]
						[case]
							value = 9,18
							[set_variable]
								name = outroom_x
								value = "$($$outroom|.start_x|+2)"
							[/set_variable]
							[set_variable]
								name = outroom_y
								value = "$($$outroom|.start_y|+6)"
							[/set_variable]
							[set_variable]
								name = outroom_sty
								value = "$($$outroom|.start_y|+2)"-"$({SIZE_Y}*4+9)"
							[/set_variable]
						[/case]
						[case]
							value = 10,19
							[set_variable]
								name = outroom_x
								value = "$($$outroom|.start_x|+2)"
							[/set_variable]
							[set_variable]
								name = outroom_y
								value = "$($$outroom|.start_y|+6)"
							[/set_variable]
							[set_variable]
								name = outroom_sty
								value = "$($$outroom|.start_y|+1)"-"$({SIZE_Y}*4+9)"
							[/set_variable]
						[/case]
						[case]
							value = 23
							[set_variable]
								name = outroom_x
								value = "$($$outroom|.start_x|+2)"
							[/set_variable]
							[set_variable]
								name = outroom_y
								value = "$($$outroom|.start_y|+6)"
							[/set_variable]
							[set_variable]
								name = outroom_sty
								value = $$outroom|.start_y|-"$({SIZE_Y}*4+9)"
							[/set_variable]
						[/case]
					[/switch]
				[/else]
			[/if]
			
		[/then]
		[else]
			###### 座標を決める
			[switch]
				variable = map_block.rooms.exit_num
				[case]
					value = 1
					###### 北
					[set_variable]
						name = outroom_x
						rand = 5.."$({SIZE_X}*4)"
					[/set_variable]
					[set_variable]
						name = outroom_y
						value = 2
					[/set_variable]
					[set_variable]
						name = outroom_sty
						value = 0-4
					[/set_variable]
				[/case]
				[case]
					value = 2
					###### 南
					[set_variable]
						name = outroom_x
						rand = 5.."$({SIZE_X}*4)"
					[/set_variable]
					[set_variable]
						name = outroom_y
						value = "$({SIZE_Y}*4+6)"
					[/set_variable]
					[set_variable]
						name = outroom_sty
						value = "$({SIZE_Y}*4+5)"-"$({SIZE_Y}*4+9)"
					[/set_variable]
				[/case]
			[/switch]
			
		[/else]
	[/if]
	#### 脱出路の描画
	[terrain]
		terrain = {TYPE}
		x= $outroom_x|
		y= $outroom_sty|
	[/terrain]
	#### 変数の整理
	[set_variable]
		name = map_block.stairs_x
		value = $outroom_x|
	[/set_variable]
	[set_variable]
		name = map_block.stairs_y
		value = $outroom_y|
	[/set_variable]
	[clear_variable]
		name = outroom,outroom_sty,switch_1,switch_2,switch_3,outroom_x,outroom_y
	[/clear_variable]
#enddef




####################### シナリオ開始時のダンジョン作成マクロ
#define ROGUE_MAP_GENERATOR SIZE_Y SIZE_X WALL ROOM PATHWAY EXIT
	
	#### SIZE_Y:Y座標の大きさ
	#### SIZE_X:X座標の大きさ
	
	#### WALL:壁の設定マクロ
	# 2種のどちらかのマクロを使う
	# {MAP_WALL_1 {SIZE_Y} {SIZE_X} "Gg^Fpu"} 壁地形が1種のタイプ：地形コードを指定
	# { MAP_WALL_2 {SIZE_Y} {SIZE_X} {CODE_WATER_A} {CODE_WATER_B}} 壁地形がランダムのタイプ：地形セットを指定(A,Bがセットになっている)
	
	#### ROOM:部屋地形セットの指定
	# {ROOMCODE_G} リストのマクロを選択する
	
	#### PATHWAY:通路の地形コード
	# Rrc  直接地形コードを入れる
	
	####################### EXIT
	####:階段作成マクロ通常版
	# {STAIR_A "^Yd4" {SIZE_X} {SIZE_Y}} 階段バージョン:階段の地形コードを入れる
	####:階段作成マクロ脱出路タイプ
	# {STAIR_A "Rrc" {SIZE_X} {SIZE_Y}} 脱出路:通路の地形コードを入れる

	###################################### ここからマクロスタート ##################################
	
	### マップ作成用変数の設定
	{MAP_TILE}
	
	############################################ マップサイズの調整
	### 1...使用するサイズのブランクマップデータを用意しておく
	### 2...マップを使用する壁地形で塗りつぶす.
	
	{WALL}
	
	
	############################################ ブランクマップの配置変数を作成
	##### 
	[set_variables]
		name = map_block
		mode=replace
		[value]
			[block]
				type = 0 # 使う
				type_set = no # 使う
				on_off = 0 # 使う
				path_check = 0
				block_num = 0
				cont = 0
			[/block]
			[rooms]
				room_num = 0 # 使う
				cluster_num = 0 # 使う
				[room]
					size = 0
					x_s = 0
					x_l = 0
					y_s = 0
					y_l = 0
				[/room]
			[/rooms]
		[/value]
	[/set_variables]
	[for]
		variable = i
		start = 0
		end = {SIZE_Y}
		step = 1
		[do]
			[set_variables]
				name = map_block.b_y[$i|]
				mode=insert
				[value]
					place = $i|
				[/value]
			[/set_variables]
			[for]
				variable = l
				start = 0
				end = {SIZE_X}
				step = 1
				[do]
					##### ブロック個別のコンテナ、座標Y=$i| 座標X=$l|
					[set_variables]
						name = map_block.b_y[$i|].b_x[$l|]
						mode=insert
						[value]
							#### ブロックのコンテナ番号を記録
							place = $i|_$l|
							#### 事前に登録する項目
							type = no
							#### 通路の数
							pathway = 0
						[/value]
					[/set_variables]
					#### この座標へのアクセス用変数  map_block.1_2 = "map_block.b_y[1].b_x[2]" のようになる
					[set_variable]
						name = map_block.$i|_$l|
						value = "map_block.b_y[$i|].b_x[$l|]"
					[/set_variable]
				[/do]
			[/for]
		[/do]
	[/for]
	
	############################################################# 各ブロックのタイプを決定する
	[for]
		variable = i
		start = 0
		#### マップの縦の行数
		end = {SIZE_Y}
		step = 1
		[do]
			[for]
				variable = l
				start = 0
				#### マップの横の行数
				end = {SIZE_X}
				step = 1
				[do]
					#### マップの外周は通路にする
					[if]
						[variable]
							name = i
							equals = 0
						[/variable]
						[or]
							[variable]
								name = i
								equals = {SIZE_Y}
							[/variable]
						[/or]
						[or]
							[variable]
								name = l
								equals = 0
							[/variable]
						[/or]
						[or]
							[variable]
								name = l
								equals = {SIZE_X}
							[/variable]
						[/or]
						[then]
							[set_variables]
								name = map_block.b_y[$i|].b_x[$l|]
								mode=merge
								[value]
									type = pathway
									mother = no
									block = 1
									layout = 23
									position = $i|_$l|
									start_x = "$($l|*4)"
									start_y = "$($i|*4)"
								[/value]
							[/set_variables]
						[/then]
					[/if]
					#### ブロックタイプを決定 すでにタイプが設定されていたらスキップ
					[if]
						[variable]
							name = map_block.b_y[$i|].b_x[$l|].type
							equals = no
						[/variable]
						[then]
							[set_variable]
								name = map_block.block.type
								rand = 1..11,2..10,3..9,4..8,5..7,6,path,path,path,path,path,path,path
							[/set_variable]
							[while]
								[variable]
									name = map_block.block[0].type_set
									equals = no
								[/variable]
								[do]
									[switch]
										variable = map_block.block.type
										[case]
											value = path
											##### 通路
											[set_variable]
												name = map_block.block[0].type_set
												value = yes
											[/set_variable]
											[set_variables]
												name = map_block.b_y[$i|].b_x[$l|]
												mode=merge
												[value]
													type = pathway
													mother = no
													block = 1
													layout = 23
													position = $i|_$l|
													start_x = "$($l|*4)"
													start_y = "$($i|*4)"
												[/value]
											[/set_variables]
										[/case]
										
										[case]
											value = 1
											##### type = room_1
											#### 障害物がないか確認  
											[if]
												[variable]
													name = map_block.b_y[$i|].b_x["$($l|+1)"].type
													equals = no
												[/variable]
												#### 部屋を設置
												[then]
												
											[set_variable]
												name = map_block.block[0].type_set
												value = yes
											[/set_variable]
														
											############### 部屋の数を更新
											[set_variables]
												name = map_block.rooms
												mode=merge
												[value]
													#### 部屋の総数
													add_to_room_num = 1
													#### クラスターID
													add_to_cluster_num = 1
												[/value]
											[/set_variables]
											############### 部屋の管理コンテナ
											[set_variables]
												name = map_block.rooms.room[$map_block.rooms.room_num|]
												mode=insert
												[value]
													######## 部屋番号
													room_id = $map_block.rooms.room_num|
													room_path = $i|_$l|
													room_type = $map_block.block.type|
												[/value]
											[/set_variables]
											############### 部屋の設置
											[set_variables]
												name = map_block.b_y[$i|].b_x[$l|]
												mode=merge
												[value]
													type = $map_block.block.type|
													role = mother
													size_x = $tile_set.b_type[$map_block.block.type|].size_x|
													size_y = $tile_set.b_type[$map_block.block.type|].size_y|
													layout = $tile_set.b_type[$map_block.block.type|].mother|
													start_x = "$($l|*4)"
													start_y = "$($i|*4)"
													x_s = $l|
													y_s = $i|
													x_l = "$($l|+$tile_set.b_type[$map_block.block.type|].size_x|-1)"
													y_l = "$($i|+$tile_set.b_type[$map_block.block.type|].size_y|-1)"
													room = $map_block.rooms.room_num|
													cluster = $map_block.rooms.cluster_num|
													block = 1
												[/value]
											[/set_variables]
											########### 境界に通路を設置
											[set_variables]
												name = map_block.b_y[$i|].b_x["$($l|+1)"]
												mode=merge
												[value]
													type = pathway
													mother = $i|_$l|
													block = 1
													layout = 23
													position = "$i|" "_" "$($l|+1)"
													start_x = "$($l|*4+4)"
													start_y = "$($i|*4)"
												[/value]
											[/set_variables]
											[set_variables]
												name = map_block.b_y["$($i|+1)"].b_x[$l|]
												mode=merge
												[value]
													type = pathway
													mother = $i|_$l|
													block = 1
													layout = 23
													position = "$($i|+1)" "_" "$l|"
													start_x = "$($l|*4)"
													start_y = "$($i|*4+4)"
												[/value]
											[/set_variables]
											[set_variables]
												name = map_block.b_y["$($i|+1)"].b_x["$($l|+1)"]
												mode=merge
												[value]
													type = pathway
													mother = $i|_$l|
													block = 1
													layout = 23
													position = "$($i|+1)" "_" "$($l|+1)"
													start_x = "$($l|*4+4)"
													start_y = "$($i|*4+4)"
												[/value]
											[/set_variables]
											
												[/then]
												[else]
													[set_variable]
														name = map_block.block.type
														value = path
													[/set_variable]
												[/else]
											[/if]
										[/case]
										
										[case]
											value = 2,3,4,5,6,7,8,9,10,11
											#### type = room_11
											#### スペースが空いているか確認
											[if]
												#### Yのスペース
												[variable]
													name = i
													less_than = "$({SIZE_Y}-$tile_set.b_type[$map_block.block.type|].size_y|)"
												[/variable]
												#### Xのスペース
												[variable]
													name = l
													less_than = "$({SIZE_X}-$tile_set.b_type[$map_block.block.type|].size_x|)"
												[/variable]
												[then]
													#### 障害物がないか確認  
													[for]
														variable = size
														start = 1
														end = $tile_set.b_type[$map_block.block.type|].size_x|
														step = 1
														[do]
															[if]
																[variable]
																	name = map_block.b_y[$i|].b_x["$($l|+$size|)"].type
																	not_equals = no
																[/variable]
																[then]
																	[set_variable]
																		name = map_block.block.on_off
																		add = 1
																	[/set_variable]
																[/then]
															[/if]
														[/do]
													[/for]
													[if]
														[variable]
															name = map_block.block.on_off
															equals = 0
														[/variable]
														#### 部屋を設置
														[then]
															[set_variable]
																name = map_block.block.type_set
																value = yes
															[/set_variable]
															############### 部屋の数を更新
															[set_variables]
																name = map_block.rooms
																mode=merge
																[value]
																	#### 部屋の総数
																	add_to_room_num = 1
																	#### クラスターID
																	add_to_cluster_num = 1
																[/value]
															[/set_variables]
															############### 部屋の管理コンテナ
															[set_variables]
																name = map_block.rooms.room[$map_block.rooms.room_num|]
																mode=insert
																[value]
																	######## 部屋番号
																	room_id = $map_block.rooms.room_num|
																	room_path = $i|_$l|
																	room_type = $map_block.block.type|
																[/value]
															[/set_variables]
															############### 部屋の設置
															[set_variables]
																name = map_block.b_y[$i|].b_x[$l|]
																mode=merge
																[value]
																	type = $map_block.block.type|
																	role = mother
																	size_x = $tile_set.b_type[$map_block.block.type|].size_x|
																	size_y = $tile_set.b_type[$map_block.block.type|].size_y|
																	layout = $tile_set.b_type[$map_block.block.type|].mother|
																	start_x = "$($l|*4)"
																	start_y = "$($i|*4)"
																	x_s = $l|
																	y_s = $i|
																	x_l = "$($l|+$tile_set.b_type[$map_block.block.type|].size_x|-1)"
																	y_l = "$($i|+$tile_set.b_type[$map_block.block.type|].size_y|-1)"
																	room = $map_block.rooms.room_num|
																	cluster = $map_block.rooms.cluster_num|
																	block = $tile_set.b_type[$map_block.block.type|].block|
																[/value]
															[/set_variables]
															########### childの登録
															[set_variable]
																name = size_y
																value = 1
															[/set_variable]
															[set_variable]
																name = size_x
																value = 2
															[/set_variable]
															[for]
																variable = size
																start = 1
																end = "$($map_block.b_y[$i|].b_x[$l|].block|-1)"
																step = 1
																[do]
																	[set_variable]
																		name = c_pos
																		value = $tile_set.b_type[$map_block.block.type|].c$size|_pos|
																	[/set_variable]
																	[if]
																		[variable]
																			name = c_pos
																			not_equals = $size_y|_$size_x|
																		[/variable]
																		[then]
																			[set_variable]
																				name = size_y
																				add = 1
																			[/set_variable]
																			[set_variable]
																				name = size_x
																				value = 1
																			[/set_variable]
																		[/then]
																	[/if]
																	#### childの座標を算出
																	[set_variable]
																		name = child_y
																		value = "$($size_y|+$i|-1)"
																	[/set_variable]
																	[set_variable]
																		name = child_x
																		value = "$($size_x|+$l|-1)"
																	[/set_variable]
																	#### motherにchildの座標を記録
																	[set_variable]
																		name = map_block.b_y[$i|].b_x[$l|].child_$size|
																		value = $child_y|_$child_x|
																	[/set_variable]
																	#### childのコンテナを設定
																	[set_variables]
																		name = map_block.b_y[$child_y|].b_x[$child_x|]
																		mode=merge
																		[value]
																			type = $map_block.block.type|
																			role = child
																			mother = $i|_$l|
																			layout = $tile_set.b_type[$map_block.block.type|].child_$size||
																			start_x = "$($child_x|*4)"
																			start_y = "$($child_y|*4)"
																		[/value]
																	[/set_variables]
																	#### 次のコンテナ番号を設定
																	[set_variable]
																		name = size_x
																		add = 1
																	[/set_variable]
																[/do]
															[/for]
															
															########### 境界に通路を設置
															[set_variable]
																name = size_y
																value = $tile_set.b_type[$map_block.block.type|].size_y|
															[/set_variable]
															[set_variable]
																name = size_x
																value = $tile_set.b_type[$map_block.block.type|].size_x|
															[/set_variable]
															##### 下辺
															[for]
																variable = size
																start = 1
																end = $size_x|
																step = 1
																[do]
																	[set_variables]
																		name = map_block.b_y["$($i|+$size_y|)"].b_x["$($l|+$size|-1)"]
																		mode=merge
																		[value]
																			type = pathway
																			mother = $i|_$l|
																			block = 1
																			layout = 23
																			position = "$($i|+$size_y|)" "_" "$($l|+$size|-1)"
																			start_x = "$(($l|+$size|-1)*4)"
																			start_y = "$(($i|+$size_y|)*4)"
																		[/value]
																	[/set_variables]
																[/do]
															[/for]
															##### 右辺
															[for]
																variable = size
																start = 1
																end = $size_y|
																step = 1
																[do]
																	[set_variables]
																		name = map_block.b_y["$($i|+$size|-1)"].b_x["$($l|+$size_x|)"]
																		mode=merge
																		[value]
																			type = pathway
																			mother = $i|_$l|
																			block = 1
																			layout = 23
																			position = "$($i|+$size|-1)" "_" "$($l|+$size_x|)"
																			start_x = "$(($l|+$size_x|)*4)"
																			start_y = "$(($i|+$size|-1)*4)"
																		[/value]
																	[/set_variables]
																[/do]
															[/for]
															##### 右下
															[set_variables]
																name = map_block.b_y["$($i|+$size_y|)"].b_x["$($l|+$size_x|)"]
																mode=merge
																[value]
																	type = pathway
																	mother = $i|_$l|
																	block = 1
																	layout = 23
																	position = "$($i|+$size_y|)" "_" "$($l|+$size_x|)"
																	start_x = "$(($i|+$size_y|)*4)"
																	start_y = "$(($l|+$size_x|)*4)"
																[/value]
															[/set_variables]
															
															[clear_variable]
																name = size_y,size_x,child_x,child_y,c_pos
															[/clear_variable]
														[/then]
														[else]
															[set_variable]
																name = map_block.block.on_off
																value = 0
															[/set_variable]
															[set_variable]
																name = map_block.block.type
																add = -1
															[/set_variable]
														[/else]
													[/if]
												[/then]
												[else]
													[set_variable]
														name = map_block.block.type
														add = -1
													[/set_variable]
												[/else]
											[/if]
										[/case]
									[/switch]
								[/do]
							[/while]
							[set_variable]
								name = map_block.block[0].type_set
								value = no
							[/set_variable]
							
							#### バグチェック用
							[set_variable]
								name = map_block.b_y[$i|].b_x[$l|].skip
								value = no
							[/set_variable]
							
						[/then]
						[else]
							#### バグチェック用
							[set_variable]
								name = map_block.b_y[$i|].b_x[$l|].skip
								value = yes
							[/set_variable]
						[/else]
					[/if]
					
				[/do]
			[/for]
			
		[/do]
	[/for]

	
	###################################################### 部屋数が1以下なら大部屋、それ以外は通常処理
	[if]
		[variable]
			name = map_block.rooms.room_num
			greater_than = 1
		[/variable]
		[then]
		###################################################### 通常処理（階段描画まで）
	
	###################################################### 部屋の描画
	[for]
		variable = i
		start = 0
		#### マップの縦の行数
		end = {SIZE_Y}
		step = 1
		[do]
			[for]
				variable = l
				start = 0
				#### マップの横の行数
				end = {SIZE_X}
				step = 1
				[do]
					[set_variable]
						name = layout
						value = $map_block.b_y[$i|].b_x[$l|].layout|
					[/set_variable]
					
					[for]
						variable = m
						start = 1
						end = 4
						step = 1
						[do]
							[switch]
							variable = tile_set.layout[$layout|].x_$m|
							[case]
								value = 1
								[set_variable]
									name = tile_set.terracode.tile_str
									rand = {ROOM}
								[/set_variable]
								[terrain]
									terrain = "$tile_set.terracode.tile_str|"
									x= "$($map_block.b_y[$i|].b_x[$l|].start_x|+$m|)"
									y= "$($map_block.b_y[$i|].b_x[$l|].start_y|+1)"
								[/terrain]
							[/case]
							[case]
								value = 2
								[set_variable]
									name = tile_set.terracode.tile_str
									rand = {ROOM}
								[/set_variable]
								[terrain]
									terrain = "$tile_set.terracode.tile_str|"
									x= "$($map_block.b_y[$i|].b_x[$l|].start_x|+$m|)"
									y= "$($map_block.b_y[$i|].b_x[$l|].start_y|+2)"
								[/terrain]
							[/case]
							[case]
								value = 3
								[set_variable]
									name = tile_set.terracode.tile_str
									rand = {ROOM}
								[/set_variable]
								[terrain]
									terrain = "$tile_set.terracode.tile_str|"
									x= "$($map_block.b_y[$i|].b_x[$l|].start_x|+$m|)"
									y= "$($map_block.b_y[$i|].b_x[$l|].start_y|+3)"
								[/terrain]
							[/case]
							[case]
								value = 4
								[set_variable]
									name = tile_set.terracode.tile_str
									rand = {ROOM}
								[/set_variable]
								[terrain]
									terrain = "$tile_set.terracode.tile_str|"
									x= "$($map_block.b_y[$i|].b_x[$l|].start_x|+$m|)"
									y= "$($map_block.b_y[$i|].b_x[$l|].start_y|+4)"
								[/terrain]
							[/case]
							[case]
								value = 1_2
								[set_variable]
									name = tile_set.terracode.tile_str
									rand = {ROOM}
								[/set_variable]
								[terrain]
									terrain = "$tile_set.terracode.tile_str|"
									x= "$($map_block.b_y[$i|].b_x[$l|].start_x|+$m|)"
									y= "$($map_block.b_y[$i|].b_x[$l|].start_y|+1)"
								[/terrain]
								[set_variable]
									name = tile_set.terracode.tile_str
									rand = {ROOM}
								[/set_variable]
								[terrain]
									terrain = "$tile_set.terracode.tile_str|"
									x= "$($map_block.b_y[$i|].b_x[$l|].start_x|+$m|)"
									y= "$($map_block.b_y[$i|].b_x[$l|].start_y|+2)"
								[/terrain]
							[/case]
							[case]
								value = 1_3
								[for]
									variable = j
									start = 1
									end = 3
									step = 1
									[do]
										[set_variable]
											name = tile_set.terracode.tile_str
											rand = {ROOM}
										[/set_variable]
										[terrain]
											terrain = "$tile_set.terracode.tile_str|"
											x = "$($map_block.b_y[$i|].b_x[$l|].start_x|+$m|)"
											y = "$($map_block.b_y[$i|].b_x[$l|].start_y|+$j|)"
										[/terrain]
									[/do]
								[/for]
							[/case]
							[case]
								value = 1_4
								[for]
									variable = j
									start = 1
									end = 4
									step = 1
									[do]
										[set_variable]
											name = tile_set.terracode.tile_str
											rand = {ROOM}
										[/set_variable]
										[terrain]
											terrain = "$tile_set.terracode.tile_str|"
											x = "$($map_block.b_y[$i|].b_x[$l|].start_x|+$m|)"
											y = "$($map_block.b_y[$i|].b_x[$l|].start_y|+$j|)"
										[/terrain]
									[/do]
								[/for]
							[/case]
							[case]
								value = 2_3
								[for]
									variable = j
									start = 2
									end = 3
									step = 1
									[do]
										[set_variable]
											name = tile_set.terracode.tile_str
											rand = {ROOM}
										[/set_variable]
										[terrain]
											terrain = "$tile_set.terracode.tile_str|"
											x = "$($map_block.b_y[$i|].b_x[$l|].start_x|+$m|)"
											y = "$($map_block.b_y[$i|].b_x[$l|].start_y|+$j|)"
										[/terrain]
									[/do]
								[/for]
							[/case]
							[case]
								value = 2_4
								[for]
									variable = j
									start = 2
									end = 4
									step = 1
									[do]
										[set_variable]
											name = tile_set.terracode.tile_str
											rand = {ROOM}
										[/set_variable]
										[terrain]
											terrain = "$tile_set.terracode.tile_str|"
											x = "$($map_block.b_y[$i|].b_x[$l|].start_x|+$m|)"
											y = "$($map_block.b_y[$i|].b_x[$l|].start_y|+$j|)"
										[/terrain]
									[/do]
								[/for]
							[/case]
							[case]
								value = 3_4
								[for]
									variable = j
									start = 3
									end = 4
									step = 1
									[do]
										[set_variable]
											name = tile_set.terracode.tile_str
											rand = {ROOM}
										[/set_variable]
										[terrain]
											terrain = "$tile_set.terracode.tile_str|"
											x = "$($map_block.b_y[$i|].b_x[$l|].start_x|+$m|)"
											y = "$($map_block.b_y[$i|].b_x[$l|].start_y|+$j|)"
										[/terrain]
									[/do]
								[/for]
							[/case]
							[/switch]
						[/do]
					[/for]
					
				[/do]
			[/for]
			
		[/do]
	[/for]
	
	[clear_variable]
		name = layout
	[/clear_variable]
	
	#####################################################
	#####################################################
	#####################################################
	#####################################################
	#####################################################
	#####################################################
	#####################################################
	#####################################################
	##################################################### 通路の配置
	
	###### 1,通路は1部屋に3本まで
	###### 2,クラスターが違う部屋に繋げる
	###### 3,クラスターが1つになったら成功
	
	### 検索用の変数を設定
	[set_variables]
		name = map_block.rooms
		mode=merge
		[value]
			### 現在の部屋番号
			search_r = 1
			### 現在のクラスター番号
			search_c = 1
			### 現在作成中の通路番号
			search_p = 1
			### 距離の近さランク
			[rank]
				num = 0
			[/rank]
		[/value]
	[/set_variables]
	###### 各部屋のコンテナパス
	[for]
		variable = i
		start = 1
		end = $map_block.rooms.room_num|
		step = 1
		[do]
			[set_variable]
				name = cont_$i|
				value = $map_block.$map_block.rooms.room[$i|].room_path||
			[/set_variable]
		[/do]
	[/for]
	
	[for]
		variable = l
		start = 1
		end = $map_block.rooms.room_num|
		step = 1
		[do]
			####################### 検索準備
			##### 現在の部屋番号をセット
			[set_variable]
				name = map_block.rooms.search_r
				value = $l|
			[/set_variable]
			##### 現在の部屋パス
			[set_variable]
				name = cont
				value = $map_block.$map_block.rooms.room[$l|].room_path||
			[/set_variable]
			##### 現在の部屋パスにランキング用データを作成
			[set_variables]
				name = $cont|.rank
				mode=insert
				[value]
					num = 0
					test = 1
					in = no
				[/value]
			[/set_variables]
			
			######## 現在の部屋番号と近い距離の部屋ランキングをつくる
			[for]
				variable = i
				start = 1
				end = $map_block.rooms.room_num|
				step = 1
				[do]
					##### 現在の部屋を除外する
					[if]
						[variable]
							name = $cont|.room
							not_equals = $$cont_$i||.room|
						[/variable]
						[then]
						
							#### 起点距離の差を取得
							[set_variable]
								name = $cont|.search_s
								value = "$($$cont_$i||.x_s|-$$cont|.x_s|+$$cont_$i||.y_s|-$$cont|.y_s|)"
							[/set_variable]
							[if]
								[variable]
									name = $cont|.search_s
									less_than = 0
								[/variable]
								[then]
									[set_variable]
										name = $cont|.search_s
										multiply = -1
									[/set_variable]
								[/then]
							[/if]
							#### x軸の距離を取得
							[set_variable]
								name = $cont|.search_x
								value = "$($$cont_$i||.x_s|-$$cont|.x_s|)"
							[/set_variable]
							[if]
								[variable]
									name = $cont|.search_x
									less_than = 0
								[/variable]
								[then]
									[set_variable]
										name = $cont|.search_x2
										value = "$($$cont_$i||.x_l|-$$cont|.x_s|)"
									[/set_variable]
									[if]
										[variable]
											name = $cont|.search_x2
											less_than = 0
										[/variable]
										[then]
											#### Xが西方向に離れている
											[set_variable]
												name = $cont|.search_x2
												multiply = -1
											[/set_variable]
											[set_variable]
												name = $cont|.search_x
												value = $$cont|.search_x2|
											[/set_variable]
											[set_variable]
												name = $cont|.search_x2
												value = west
											[/set_variable]
										[/then]
										[else]
											#### Xが重なっている。
											[set_variable]
												name = $cont|.search_x
												value = 0
											[/set_variable]
											[set_variable]
												name = $cont|.search_x2
												value = center
											[/set_variable]
										[/else]
									[/if]
								[/then]
								[else]
									[set_variable]
										name = $cont|.search_x2
										value = "$($$cont_$i||.x_s|-$$cont|.x_l|)"
									[/set_variable]
									[if]
										[variable]
											name = $cont|.search_x2
											less_than = 1
										[/variable]
										[then]
											#### Xが重なっている。
											[set_variable]
												name = $cont|.search_x
												value = 0
											[/set_variable]
											[set_variable]
												name = $cont|.search_x2
												value = center
											[/set_variable]
										[/then]
										[else]
											#### Xが東方向に離れている
											[set_variable]
												name = $cont|.search_x
												value = $$cont|.search_x2|
											[/set_variable]
											[set_variable]
												name = $cont|.search_x2
												value = east
											[/set_variable]
										[/else]
									[/if]
								[/else]
							[/if]
							#### y軸の距離を取得
							[set_variable]
								name = $cont|.search_y
								value = "$($$cont_$i||.y_s|-$$cont|.y_s|)"
							[/set_variable]
							[if]
								[variable]
									name = $cont|.search_y
									less_than = 0
								[/variable]
								[then]
									[set_variable]
										name = $cont|.search_y2
										value = "$($$cont_$i||.y_l|-$$cont|.y_s|)"
									[/set_variable]
									[if]
										[variable]
											name = $cont|.search_y2
											less_than = 0
										[/variable]
										[then]
											#### Yが北方向に離れている
											[set_variable]
												name = $cont|.search_y2
												multiply = -1
											[/set_variable]
											[set_variable]
												name = $cont|.search_y
												value = $$cont|.search_y2|
											[/set_variable]
											[set_variable]
												name = $cont|.search_y2
												value = north
											[/set_variable]
										[/then]
										[else]
											#### Yが重なっている。
											[set_variable]
												name = $cont|.search_y
												value = 0
											[/set_variable]
											[set_variable]
												name = $cont|.search_y2
												value = center
											[/set_variable]
										[/else]
									[/if]
								[/then]
								[else]
									[set_variable]
										name = $cont|.search_y2
										value = "$($$cont_$i||.y_s|-$$cont|.y_l|)"
									[/set_variable]
									[if]
										[variable]
											name = $cont|.search_y2
											less_than = 1
										[/variable]
										[then]
											#### Yが重なっている。
											[set_variable]
												name = $cont|.search_y
												value = 0
											[/set_variable]
											[set_variable]
												name = $cont|.search_y2
												value = center
											[/set_variable]
										[/then]
										[else]
											#### Yが南方向に離れている
											[set_variable]
												name = $cont|.search_y
												value = $$cont|.search_y2|
											[/set_variable]
											[set_variable]
												name = $cont|.search_y2
												value = south
											[/set_variable]
										[/else]
									[/if]
								[/else]
							[/if]
							##### x,yの郷里を合計
							[set_variable]
								name = $cont|.search_xy
								value = "$($$cont|.search_x|+$$cont|.search_y|)"
							[/set_variable]
							
							##### ランキングに登録
							[set_variable]
								name = $cont|.rank[0].in
								value = no
							[/set_variable]
							[set_variable]
								name = $cont|.rank[0].test
								value = 1
							[/set_variable]
							[set_variable]
								name = $cont|.rank[0].num
								add = 1
							[/set_variable]
							[while]
								[variable]
									name = $cont|.rank[0].in
									equals = no
								[/variable]
								[do]
									[if]
										[variable]
											name = $cont|.rank[$$cont|.rank[0].test|].search_xy
											greater_than = $$cont|.search_xy|
										[/variable]
										[or]
											[variable]
												name = $cont|.rank[0].test
												equals = $$cont|.rank[0].num|
											[/variable]
										[/or]
										[then]
											[set_variables]
												name = $cont|.rank[$$cont|.rank[0].test|]
												mode=insert
												[value]
													search_xy = $$cont|.search_xy|
													search_s = $$cont|.search_s|
													room_num = $i|
													search_x = $$cont|.search_x|
													search_x2 = $$cont|.search_x2|
													search_y = $$cont|.search_y|
													search_y2 = $$cont|.search_y2|
													path = no
												[/value]
											[/set_variables]
											[set_variable]
												name = $cont|.rank[0].in
												value = yes
											[/set_variable]
										[/then]
										[else]
											[set_variable]
												name = $cont|.rank[0].test
												add = 1
											[/set_variable]
										[/else]
									[/if]
								[/do]
							[/while]
						[/then]
					[/if]
					###### 一部屋分のランキングが完成
				[/do]
			[/for]
		[/do]
	[/for]
					
	##### ランキング1位と繋げるか検討する
	[for]
		variable = i
		start = 1
		end = $map_block.rooms.room_num|
		step = 1
		[do]
			##### 現在の部屋パス
			[set_variable]
				name = cont
				value = $cont_$i||
			[/set_variable]
			[set_variable]
				name = $cont|.on_off
				value = on
			[/set_variable]
			######## 現在の部屋番号と近い順に繋げるか検討
			[if]
				######## 開通している通路が3なら繋げない
				[variable]
					name = $cont|.pathway
					less_than = 3
				[/variable]
				[then]
					[for]
						variable = l
						start = 1
						end = $$cont|.rank[0].num|
						step = 1
						[do]
							##### 検討する順位 = $l|
							
							##### 検討する順位の部屋のパスを作成
							[set_variable]
								name = part
								value = $cont_$$cont|.rank[$l|].room_num||
							[/set_variable]
							#### クラスターが異なり、通路が最大数になっていないなら通路を開く
							[if]
								[variable]
									name = $cont|.cluster
									not_equals = $$part|.cluster|
								[/variable]
								[variable]
									name = $cont|.on_off
									equals = on
								[/variable]
								[variable]
									name = $part|.pathway
									less_than = 3
								[/variable]
								[then]
									#### 変数を更新
									[set_variable]
										name = $cont|.on_off
										value = off
									[/set_variable]
									[set_variable]
										name = $cont|.pathway
										add = 1
									[/set_variable]
									[set_variable]
										name = $cont|.partner_clus
										value = $$part|.cluster|
									[/set_variable]
									[set_variable]
										name = $cont|.rank[$l|].path
										value = 1
									[/set_variable]
									[set_variable]
										name = map_block.rooms.cluster_num
										add = -1
									[/set_variable]
									###### 相手側の通路数も増やす
									[set_variable]
										name = $part|.pathway
										add = 1
									[/set_variable]
									[set_variable]
										name = $part|.cluster
										value = $$cont|.cluster|
									[/set_variable]
									[set_variable]
										name = $part|.from_path_$$part|.pathway|
										value = $$cont|.room|
									[/set_variable]
									###### クラスターを吸収
									[for]
										variable = cl
										start = 1
										end = $map_block.rooms.room_num|
										step = 1
										[do]
											[if]
												[variable]
													name = $cont_$cl||.cluster
													equals = $$cont|.partner_clus|
												[/variable]
												[then]
													[set_variable]
														name = $cont_$cl||.cluster
														value = $$cont|.cluster|
													[/set_variable]
												[/then]
											[/if]
										[/do]
									[/for]
								[/then]
							[/if]
					
						[/do]
					[/for]
				[/then]
			[/if]
		[/do]
	[/for]
	
	
	
	
	
	###################################################### 通路のルートを決める
	[for]
		variable = i
		start = 1
		end = $map_block.rooms.room_num|
		step = 1
		[do]
			##### 現在の部屋パス
			[set_variable]
				name = cont
				value = $cont_$i||
			[/set_variable]
			[set_variable]
				name = $cont|.on_off
				value = on
			[/set_variable]
			##### 繋げる部屋のパス
			[for]
				variable = l
				start = 1
				end = $$cont|.rank[0].num|
				step = 1
				[do]
					[if]
						[variable]
							name = $cont|.rank[$l|].path
							not_equals = no
						[/variable]
						[then]
							[set_variable]
								name = part
								value = $cont_$$cont|.rank[$l|].room_num||
							[/set_variable]
							[set_variable]
								name = $cont|.link
								value = $l|
							[/set_variable]
						[/then]
					[/if]
				[/do]
			[/for]
			
			
			
			[if]
				[variable]
					name = $cont|.link
					not_equals = $empty
				[/variable]
				[then]
					##### 繋げる方向を決める
					[if]
						[variable]
							name = $cont|.rank[$$cont|.link|].search_x
							greater_than = $$cont|.rank[$$cont|.link|].search_y|
						[/variable]
						[then]
							[set_variable]
								name = $cont|.link_to
								value = $$cont|.rank[$$cont|.link|].search_x2|
							[/set_variable]
						[/then]
						[else]
							[set_variable]
								name = $cont|.link_to
								value = $$cont|.rank[$$cont|.link|].search_y2|
							[/set_variable]
						[/else]
					[/if]
				[/then]
				[else]
					##### 繋げる部屋がない場合
					[set_variable]
						name = $cont|.link_to
						value = no
					[/set_variable]
				[/else]
			[/if]
			
			
			
			
			#### 開始点と終了点、移動距離を決める
			[switch]
				variable = $cont|.link_to
				[case]
					value = east
					[set_variable]
						name = $cont|.link_st_x
						value = "$$cont|.x_l|"
					[/set_variable]
					[set_variable]
						name = $cont|.link_st_y
						rand = "$$cont|.y_s|".."$$cont|.y_l|"
					[/set_variable]
					[set_variable]
						name = $cont|.link_en_x
						value = "$$part|.x_s|"
					[/set_variable]
					[set_variable]
						name = $cont|.link_en_y
						rand = "$$part|.y_s|".."$$part|.y_l|"
					[/set_variable]
					[set_variables]
						name = $cont|.root
						mode = append
						[value]
							link_move = "$("$$cont|.link_en_x|"-"$$cont|.link_st_x|")"
							st_x = "$$cont|.link_st_x|"
							st_y = "$$cont|.link_st_y|"
							en_x = "$$cont|.link_en_x|"
							en_y = "$$cont|.link_en_y|"
							num = 0
						[/value]
					[/set_variables]
					#### どちらに曲がるか決める
					[if]
						[variable]
							name = $cont|.link_st_y
							greater_than = $$cont|.link_en_y|
						[/variable]
						[then]
							[set_variable]
								name = $cont|.link_turn
								value = north
							[/set_variable]
						[/then]
						[else]
							[if]
								[variable]
									name = $cont|.link_st_y
									less_than = $$cont|.link_en_y|
								[/variable]
								[then]
									[set_variable]
										name = $cont|.link_turn
										value = south
									[/set_variable]
								[/then]
								[else]
									[set_variable]
										name = $cont|.link_turn
										value = no
									[/set_variable]
								[/else]
							[/if]
						[/else]
					[/if]
					
					#### 移動ルートを決める
					[set_variable]
						name = $cont|.on_off
						value = on
					[/set_variable]
					[while]
						[variable]
							name = $cont|.root.link_move
							greater_than = 0
						[/variable]
						[do]
							[if]
								[variable]
									name = $cont|.on_off
									equals = on
								[/variable]
								[then]
									[set_variable]
										name = $cont|.on_off
										value = off
									[/set_variable]
									[set_variable]
										name = $cont|.link_st_x
										add = 1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].link_move
										add = -1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].num|]
										mode = insert
										[value]
											x = $$cont|.link_st_x|
											y = $$cont|.link_st_y|
											path_type = 0
											root_type = st
										[/value]
									[/set_variables]
								[/then]
								[else]
									[set_variable]
										name = $cont|.on_off
										value = on
									[/set_variable]
									[set_variable]
										name = $cont|.link_en_x
										add = -1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].link_move
										add = -1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].num|]
										mode = insert
										[value]
											x = $$cont|.link_en_x|
											y = $$cont|.link_en_y|
											path_type = 0
											root_type = en
										[/value]
									[/set_variables]
								[/else]
							[/if]
						[/do]
					[/while]
					########### 曲がり角のルートタイプを変更
					[switch]
						variable = $cont|.link_turn
						[case]
							value = north
							[if]
								[variable]
									name = $cont|.root[$$cont|.root[0].num|].root_type
									equals = st
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 2
									[/set_variable]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 5
									[/set_variable]
								[/else]
							[/if]
						[/case]
						[case]
							value = south
							[if]
								[variable]
									name = $cont|.root[$$cont|.root[0].num|].root_type
									equals = st
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 3
									[/set_variable]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 4
									[/set_variable]
								[/else]
							[/if]
						[/case]
					[/switch]
					################## 曲がって進む
					[set_variable]
						name = $cont|.root[0].turn_num
						value = $$cont|.root[0].num|
					[/set_variable]
					[while]
						[variable]
							name = $cont|.link_st_y
							not_equals = $$cont|.link_en_y|
						[/variable]
						[variable]
							name = $cont|.link_turn
							not_equals = no
						[/variable]
						[do]
							[if]
								[variable]
									name = $cont|.link_turn
									equals = north
								[/variable]
								[then]
									[set_variable]
										name = $cont|.link_st_y
										add = -1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[if]
										[variable]
											name = $cont|.link_st_y
											not_equals = $$cont|.link_en_y|
										[/variable]
										[then]
											[set_variables]
												name = $cont|.root[$$cont|.root[0].turn_num|]
												mode = insert
												[value]
													x = $$cont|.link_st_x|
													y = $$cont|.link_st_y|
													path_type = 1
												[/value]
											[/set_variables]
										[/then]
									[/if]
								[/then]
								[else]
									[set_variable]
										name = $cont|.link_st_y
										add = 1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[if]
										[variable]
											name = $cont|.link_st_y
											not_equals = $$cont|.link_en_y|
										[/variable]
										[then]
											[set_variables]
												name = $cont|.root[$$cont|.root[0].turn_num|]
												mode = insert
												[value]
													x = $$cont|.link_st_x|
													y = $$cont|.link_st_y|
													path_type = 1
												[/value]
											[/set_variables]
										[/then]
									[/if]
								[/else]
							[/if]
						[/do]
					[/while]
					[if]
						[variable]
							name = $cont|.link_turn
							not_equals = no
						[/variable]
						[then]
							[set_variable]
								name = $cont|.root[0].turn_num
								add = -1
							[/set_variable]
						[/then]
					[/if]
					########### 曲がり角のルートタイプを変更
					[set_variable]
						name = $cont|.root[0].num
						add = -1
					[/set_variable]
					[switch]
						variable = $cont|.link_turn
						[case]
							value = north
							[if]
								[variable]
									name = $cont|.root[$$cont|.root[0].num|].root_type
									equals = st
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 2
									[/set_variable]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 5
									[/set_variable]
								[/else]
							[/if]
						[/case]
						[case]
							value = south
							[if]
								[variable]
									name = $cont|.root[$$cont|.root[0].num|].root_type
									equals = st
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 3
									[/set_variable]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 4
									[/set_variable]
								[/else]
							[/if]
						[/case]
						[else]
							[clear_variable]
								name = $cont|.root[$$cont|.root[0].num|]
							[/clear_variable]
							[set_variable]
								name = $cont|.root[0].turn_num
								add = -1
							[/set_variable]
						[/else]
					[/switch]
					
				[/case]
				
				
				
				[case]
					value = west
					[set_variable]
						name = $cont|.link_st_x
						value = "$$cont|.x_s|"
					[/set_variable]
					[set_variable]
						name = $cont|.link_st_y
						rand = "$$cont|.y_s|".."$$cont|.y_l|"
					[/set_variable]
					[set_variable]
						name = $cont|.link_en_x
						value = "$$part|.x_l|"
					[/set_variable]
					[set_variable]
						name = $cont|.link_en_y
						rand = "$$part|.y_s|".."$$part|.y_l|"
					[/set_variable]
					[set_variables]
						name = $cont|.root
						mode = append
						[value]
							link_move = "$("$$cont|.link_st_x|"-"$$cont|.link_en_x|")"
							st_x = "$$cont|.link_st_x|"
							st_y = "$$cont|.link_st_y|"
							en_x = "$$cont|.link_en_x|"
							en_y = "$$cont|.link_en_y|"
							num = 0
						[/value]
					[/set_variables]
					#### どちらに曲がるか決める
					[if]
						[variable]
							name = $cont|.link_st_y
							greater_than = $$cont|.link_en_y|
						[/variable]
						[then]
							[set_variable]
								name = $cont|.link_turn
								value = north
							[/set_variable]
						[/then]
						[else]
							[if]
								[variable]
									name = $cont|.link_st_y
									less_than = $$cont|.link_en_y|
								[/variable]
								[then]
									[set_variable]
										name = $cont|.link_turn
										value = south
									[/set_variable]
								[/then]
								[else]
									[set_variable]
										name = $cont|.link_turn
										value = no
									[/set_variable]
								[/else]
							[/if]
						[/else]
					[/if]
					
					
					#### 移動ルートを決める
					[set_variable]
						name = $cont|.on_off
						value = on
					[/set_variable]
					[while]
						[variable]
							name = $cont|.root.link_move
							greater_than = 0
						[/variable]
						[do]
							[if]
								[variable]
									name = $cont|.on_off
									equals = on
								[/variable]
								[then]
									[set_variable]
										name = $cont|.on_off
										value = off
									[/set_variable]
									[set_variable]
										name = $cont|.link_st_x
										add = -1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].link_move
										add = -1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].num|]
										mode = insert
										[value]
											x = $$cont|.link_st_x|
											y = $$cont|.link_st_y|
											path_type = 0
											root_type = st
										[/value]
									[/set_variables]
								[/then]
								[else]
									[set_variable]
										name = $cont|.on_off
										value = on
									[/set_variable]
									[set_variable]
										name = $cont|.link_en_x
										add = 1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].link_move
										add = -1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].num|]
										mode = insert
										[value]
											x = $$cont|.link_en_x|
											y = $$cont|.link_en_y|
											path_type = 0
											root_type = en
										[/value]
									[/set_variables]
								[/else]
							[/if]
						[/do]
					[/while]
					########### 曲がり角のルートタイプを変更
					[switch]
						variable = $cont|.link_turn
						[case]
							value = north
							[if]
								[variable]
									name = $cont|.root[$$cont|.root[0].num|].root_type
									equals = st
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 4
									[/set_variable]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 3
									[/set_variable]
								[/else]
							[/if]
						[/case]
						[case]
							value = south
							[if]
								[variable]
									name = $cont|.root[$$cont|.root[0].num|].root_type
									equals = st
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 5
									[/set_variable]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 2
									[/set_variable]
								[/else]
							[/if]
						[/case]
					[/switch]
					################## 曲がって進む
					[set_variable]
						name = $cont|.root[0].turn_num
						value = $$cont|.root[0].num|
					[/set_variable]
					[while]
						[variable]
							name = $cont|.link_st_y
							not_equals = $$cont|.link_en_y|
						[/variable]
						[variable]
							name = $cont|.link_turn
							not_equals = no
						[/variable]
						[do]
							[if]
								[variable]
									name = $cont|.link_turn
									equals = north
								[/variable]
								[then]
									[set_variable]
										name = $cont|.link_st_y
										add = -1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[if]
										[variable]
											name = $cont|.link_st_y
											not_equals = $$cont|.link_en_y|
										[/variable]
										[then]
											[set_variables]
												name = $cont|.root[$$cont|.root[0].turn_num|]
												mode = insert
												[value]
													x = $$cont|.link_st_x|
													y = $$cont|.link_st_y|
													path_type = 1
												[/value]
											[/set_variables]
										[/then]
									[/if]
								[/then]
								[else]
									[set_variable]
										name = $cont|.link_st_y
										add = 1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[if]
										[variable]
											name = $cont|.link_st_y
											not_equals = $$cont|.link_en_y|
										[/variable]
										[then]
											[set_variables]
												name = $cont|.root[$$cont|.root[0].turn_num|]
												mode = insert
												[value]
													x = $$cont|.link_st_x|
													y = $$cont|.link_st_y|
													path_type = 1
												[/value]
											[/set_variables]
										[/then]
									[/if]
								[/else]
							[/if]
						[/do]
					[/while]
					
					[if]
						[variable]
							name = $cont|.link_turn
							not_equals = no
						[/variable]
						[then]
							[set_variable]
								name = $cont|.root[0].turn_num
								add = -1
							[/set_variable]
						[/then]
					[/if]
					########### 曲がり角のルートタイプを変更
					[set_variable]
						name = $cont|.root[0].num
						add = -1
					[/set_variable]
					[switch]
						variable = $cont|.link_turn
						[case]
							value = north
							[if]
								[variable]
									name = $cont|.root[$$cont|.root[0].num|].root_type
									equals = st
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 4
									[/set_variable]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 3
									[/set_variable]
								[/else]
							[/if]
						[/case]
						[case]
							value = south
							[if]
								[variable]
									name = $cont|.root[$$cont|.root[0].num|].root_type
									equals = st
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 5
									[/set_variable]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 2
									[/set_variable]
								[/else]
							[/if]
						[/case]
						[else]
							[clear_variable]
								name = $cont|.root[$$cont|.root[0].num|]
							[/clear_variable]
							[set_variable]
								name = $cont|.root[0].turn_num
								add = -1
							[/set_variable]
						[/else]
					[/switch]
					
					
				[/case]
				
				
				
				
				[case]
					value = north
					[set_variable]
						name = $cont|.link_st_y
						value = "$$cont|.y_s|"
					[/set_variable]
					[set_variable]
						name = $cont|.link_st_x
						rand = "$$cont|.x_s|".."$$cont|.x_l|"
					[/set_variable]
					[set_variable]
						name = $cont|.link_en_y
						value = "$$part|.y_l|"
					[/set_variable]
					[set_variable]
						name = $cont|.link_en_x
						rand = "$$part|.x_s|".."$$part|.x_l|"
					[/set_variable]
					[set_variables]
						name = $cont|.root
						mode = append
						[value]
							link_move = "$("$$cont|.link_st_y|"-"$$cont|.link_en_y|")"
							st_x = "$$cont|.link_st_x|"
							st_y = "$$cont|.link_st_y|"
							en_x = "$$cont|.link_en_x|"
							en_y = "$$cont|.link_en_y|"
							num = 0
						[/value]
					[/set_variables]
					#### どちらに曲がるか決める
					[if]
						[variable]
							name = $cont|.link_st_x
							greater_than = $$cont|.link_en_x|
						[/variable]
						[then]
							[set_variable]
								name = $cont|.link_turn
								value = west
							[/set_variable]
						[/then]
						[else]
							[if]
								[variable]
									name = $cont|.link_st_x
									less_than = $$cont|.link_en_x|
								[/variable]
								[then]
									[set_variable]
										name = $cont|.link_turn
										value = east
									[/set_variable]
								[/then]
								[else]
									[set_variable]
										name = $cont|.link_turn
										value = no
									[/set_variable]
								[/else]
							[/if]
						[/else]
					[/if]
					
					
					#### 移動ルートを決める
					[set_variable]
						name = $cont|.on_off
						value = on
					[/set_variable]
					[while]
						[variable]
							name = $cont|.root.link_move
							greater_than = 0
						[/variable]
						[do]
							[if]
								[variable]
									name = $cont|.on_off
									equals = on
								[/variable]
								[then]
									[set_variable]
										name = $cont|.on_off
										value = off
									[/set_variable]
									[set_variable]
										name = $cont|.link_st_y
										add = -1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].link_move
										add = -1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].num|]
										mode = insert
										[value]
											x = $$cont|.link_st_x|
											y = $$cont|.link_st_y|
											path_type = 1
											root_type = st
										[/value]
									[/set_variables]
								[/then]
								[else]
									[set_variable]
										name = $cont|.on_off
										value = on
									[/set_variable]
									[set_variable]
										name = $cont|.link_en_y
										add = 1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].link_move
										add = -1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].num|]
										mode = insert
										[value]
											x = $$cont|.link_en_x|
											y = $$cont|.link_en_y|
											path_type = 1
											root_type = en
										[/value]
									[/set_variables]
								[/else]
							[/if]
						[/do]
					[/while]
					########### 曲がり角のルートタイプを変更
					[switch]
						variable = $cont|.link_turn
						[case]
							value = east
							[if]
								[variable]
									name = $cont|.root[$$cont|.root[0].num|].root_type
									equals = st
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 5
									[/set_variable]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 2
									[/set_variable]
								[/else]
							[/if]
						[/case]
						[case]
							value = west
							[if]
								[variable]
									name = $cont|.root[$$cont|.root[0].num|].root_type
									equals = st
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 3
									[/set_variable]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 4
									[/set_variable]
								[/else]
							[/if]
						[/case]
					[/switch]
					################## 曲がって進む
					[set_variable]
						name = $cont|.root[0].turn_num
						value = $$cont|.root[0].num|
					[/set_variable]
					[while]
						[variable]
							name = $cont|.link_st_x
							not_equals = $$cont|.link_en_x|
						[/variable]
						[variable]
							name = $cont|.link_turn
							not_equals = no
						[/variable]
						[do]
							[if]
								[variable]
									name = $cont|.link_turn
									equals = east
								[/variable]
								[then]
									[set_variable]
										name = $cont|.link_st_x
										add = 1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[if]
										[variable]
											name = $cont|.link_st_x
											not_equals = $$cont|.link_en_x|
										[/variable]
										[then]
											[set_variables]
												name = $cont|.root[$$cont|.root[0].turn_num|]
												mode = insert
												[value]
													x = $$cont|.link_st_x|
													y = $$cont|.link_st_y|
													path_type = 0
												[/value]
											[/set_variables]
										[/then]
									[/if]
								[/then]
								[else]
									[set_variable]
										name = $cont|.link_st_x
										add = -1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[if]
										[variable]
											name = $cont|.link_st_x
											not_equals = $$cont|.link_en_x|
										[/variable]
										[then]
											[set_variables]
												name = $cont|.root[$$cont|.root[0].turn_num|]
												mode = insert
												[value]
													x = $$cont|.link_st_x|
													y = $$cont|.link_st_y|
													path_type = 0
												[/value]
											[/set_variables]
										[/then]
									[/if]
								[/else]
							[/if]
						[/do]
					[/while]
					[if]
						[variable]
							name = $cont|.link_turn
							not_equals = no
						[/variable]
						[then]
							[set_variable]
								name = $cont|.root[0].turn_num
								add = -1
							[/set_variable]
						[/then]
					[/if]
					########### 曲がり角のルートタイプを変更
					[set_variable]
						name = $cont|.root[0].num
						add = -1
					[/set_variable]
					[switch]
						variable = $cont|.link_turn
						[case]
							value = east
							[if]
								[variable]
									name = $cont|.root[$$cont|.root[0].num|].root_type
									equals = st
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 5
									[/set_variable]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 2
									[/set_variable]
								[/else]
							[/if]
						[/case]
						[case]
							value = west
							[if]
								[variable]
									name = $cont|.root[$$cont|.root[0].num|].root_type
									equals = st
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 3
									[/set_variable]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 4
									[/set_variable]
								[/else]
							[/if]
						[/case]
						[else]
							[clear_variable]
								name = $cont|.root[$$cont|.root[0].num|]
							[/clear_variable]
							[set_variable]
								name = $cont|.root[0].turn_num
								add = -1
							[/set_variable]
						[/else]
					[/switch]
					
				[/case]
				[case]
					value = south
					[set_variable]
						name = $cont|.link_st_y
						value = "$$cont|.y_l|"
					[/set_variable]
					[set_variable]
						name = $cont|.link_st_x
						rand = "$$cont|.x_s|".."$$cont|.x_l|"
					[/set_variable]
					[set_variable]
						name = $cont|.link_en_y
						value = "$$part|.y_s|"
					[/set_variable]
					[set_variable]
						name = $cont|.link_en_x
						rand = "$$part|.x_s|".."$$part|.x_l|"
					[/set_variable]
					[set_variables]
						name = $cont|.root
						mode = append
						[value]
							link_move = "$("$$cont|.link_en_y|"-"$$cont|.link_st_y|")"
							st_x = "$$cont|.link_st_x|"
							st_y = "$$cont|.link_st_y|"
							en_x = "$$cont|.link_en_x|"
							en_y = "$$cont|.link_en_y|"
							num = 0
						[/value]
					[/set_variables]
					#### どちらに曲がるか決める
					[if]
						[variable]
							name = $cont|.link_st_x
							greater_than = $$cont|.link_en_x|
						[/variable]
						[then]
							[set_variable]
								name = $cont|.link_turn
								value = west
							[/set_variable]
						[/then]
						[else]
							[if]
								[variable]
									name = $cont|.link_st_x
									less_than = $$cont|.link_en_x|
								[/variable]
								[then]
									[set_variable]
										name = $cont|.link_turn
										value = east
									[/set_variable]
								[/then]
								[else]
									[set_variable]
										name = $cont|.link_turn
										value = no
									[/set_variable]
								[/else]
							[/if]
						[/else]
					[/if]
					
					#### 移動ルートを決める
					[set_variable]
						name = $cont|.on_off
						value = on
					[/set_variable]
					[while]
						[variable]
							name = $cont|.root.link_move
							greater_than = 0
						[/variable]
						[do]
							[if]
								[variable]
									name = $cont|.on_off
									equals = on
								[/variable]
								[then]
									[set_variable]
										name = $cont|.on_off
										value = off
									[/set_variable]
									[set_variable]
										name = $cont|.link_st_y
										add = 1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].link_move
										add = -1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].num|]
										mode = insert
										[value]
											x = $$cont|.link_st_x|
											y = $$cont|.link_st_y|
											path_type = 1
											root_type = st
										[/value]
									[/set_variables]
								[/then]
								[else]
									[set_variable]
										name = $cont|.on_off
										value = on
									[/set_variable]
									[set_variable]
										name = $cont|.link_en_y
										add = -1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].link_move
										add = -1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].num|]
										mode = insert
										[value]
											x = $$cont|.link_en_x|
											y = $$cont|.link_en_y|
											path_type = 1
											root_type = en
										[/value]
									[/set_variables]
								[/else]
							[/if]
						[/do]
					[/while]
					########### 曲がり角のルートタイプを変更
					[switch]
						variable = $cont|.link_turn
						[case]
							value = east
							[if]
								[variable]
									name = $cont|.root[$$cont|.root[0].num|].root_type
									equals = st
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 4
									[/set_variable]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 3
									[/set_variable]
								[/else]
							[/if]
						[/case]
						[case]
							value = west
							[if]
								[variable]
									name = $cont|.root[$$cont|.root[0].num|].root_type
									equals = st
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 2
									[/set_variable]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 5
									[/set_variable]
								[/else]
							[/if]
						[/case]
					[/switch]
					################## 曲がって進む
					[set_variable]
						name = $cont|.root[0].turn_num
						value = $$cont|.root[0].num|
					[/set_variable]
					[while]
						[variable]
							name = $cont|.link_st_x
							not_equals = $$cont|.link_en_x|
						[/variable]
						[variable]
							name = $cont|.link_turn
							not_equals = no
						[/variable]
						[do]
							[if]
								[variable]
									name = $cont|.link_turn
									equals = east
								[/variable]
								[then]
									[set_variable]
										name = $cont|.link_st_x
										add = 1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[if]
										[variable]
											name = $cont|.link_st_x
											not_equals = $$cont|.link_en_x|
										[/variable]
										[then]
											[set_variables]
												name = $cont|.root[$$cont|.root[0].turn_num|]
												mode = insert
												[value]
													x = $$cont|.link_st_x|
													y = $$cont|.link_st_y|
													path_type = 0
												[/value]
											[/set_variables]
										[/then]
									[/if]
								[/then]
								[else]
									[set_variable]
										name = $cont|.link_st_x
										add = -1
									[/set_variable]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[if]
										[variable]
											name = $cont|.link_st_x
											not_equals = $$cont|.link_en_x|
										[/variable]
										[then]
											[set_variables]
												name = $cont|.root[$$cont|.root[0].turn_num|]
												mode = insert
												[value]
													x = $$cont|.link_st_x|
													y = $$cont|.link_st_y|
													path_type = 0
												[/value]
											[/set_variables]
										[/then]
									[/if]
								[/else]
							[/if]
						[/do]
					[/while]
					[if]
						[variable]
							name = $cont|.link_turn
							not_equals = no
						[/variable]
						[then]
							[set_variable]
								name = $cont|.root[0].turn_num
								add = -1
							[/set_variable]
						[/then]
					[/if]
					########### 曲がり角のルートタイプを変更
					[set_variable]
						name = $cont|.root[0].num
						add = -1
					[/set_variable]
					[switch]
						variable = $cont|.link_turn
						[case]
							value = east
							[if]
								[variable]
									name = $cont|.root[$$cont|.root[0].num|].root_type
									equals = st
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 4
									[/set_variable]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 3
									[/set_variable]
								[/else]
							[/if]
						[/case]
						[case]
							value = west
							[if]
								[variable]
									name = $cont|.root[$$cont|.root[0].num|].root_type
									equals = st
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 2
									[/set_variable]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[$$cont|.root[0].num|].path_type
										value = 5
									[/set_variable]
								[/else]
							[/if]
						[/case]
						[else]
							[clear_variable]
								name = $cont|.root[$$cont|.root[0].num|]
							[/clear_variable]
							[set_variable]
								name = $cont|.root[0].turn_num
								add = -1
							[/set_variable]
						[/else]
					[/switch]
					
				[/case]
				[case]
					value = no
					[set_variables]
						name = $cont|.root
						mode = append
						[value]
							link_move = 0
							num = 0
							turn_num = 0
						[/value]
					[/set_variables]
				[/case]
			[/switch]
			
		[/do]
	[/for]
	
	
	
	
	
	
	###################################################### 開始点終了点の状態を調べる
	[for]
		variable = i
		start = 1
		end = $map_block.rooms.room_num|
		step = 1
		[do]
			[set_variable]
				name = cont
				value = $cont_$i||
			[/set_variable]
			#### つなぐ部屋がない場合は何もしない
			[if]
				[variable]
					name = $cont|.root[0].turn_num
					not_equals = 0
				[/variable]
				[then]
			
			###### スタート地点のレイアウト
			[set_variable]
				name = $cont|.root[0].st_l
				value = $map_block.b_y[$$cont|.root[0].st_y|].b_x[$$cont|.root[0].st_x|].layout|
			[/set_variable]
			###### つながる通路のタイプ
			[set_variable]
				name = $cont|.root[0].st_to_p
				value = $$cont|.root[1].path_type|
			[/set_variable]
			###### ゴール地点のレイアウト
			[set_variable]
				name = $cont|.root[0].en_l
				value = $map_block.b_y[$$cont|.root[0].en_y|].b_x[$$cont|.root[0].en_x|].layout|
			[/set_variable]
			###### つながる通路のタイプ
			[if]
				[variable]
					name = $cont|.link_turn
					equals = no
				[/variable]
				[then]
					[set_variable]
						name = $cont|.root[0].en_to_p
						value = $$cont|.root[1].path_type|
					[/set_variable]
				[/then]
				[else]
					[set_variable]
						name = $cont|.root[0].en_to_p
						value = $$cont|.root[2].path_type|
					[/set_variable]
				[/else]
			[/if]
			###### スタート地点からどっちへ進んだか
			[switch]
				variable = $cont|.link_to
				[case]
					value = west
					######## スタート地点のレイアウトで分岐
					[switch]
						variable = $cont|.root[0].st_l
						[case]
							value = 4
							##### 通路コンテナ番号の更新
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							##### 付け足し用通路データ
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].st_x|
									y = $$cont|.root[0].st_y|
									path_type = 6
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 5
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].st_x|
									y = $$cont|.root[0].st_y|
									path_type = 7
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 6
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].st_x|
									y = $$cont|.root[0].st_y|
									path_type = 8
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 9
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].st_x|
									y = $$cont|.root[0].st_y|
									path_type = 9
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 10
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].st_x|
									y = $$cont|.root[0].st_y|
									path_type = 10
								[/value]
							[/set_variables]
						[/case]
						####################################### 問題のある場所
						#######################################
						#######################################
						[case]
							value = 23
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].en_x|
									y = $$cont|.root[0].en_y|
									path_type = 0
								[/value]
							[/set_variables]
							[if]
								[variable]
									name = $cont|.b_y[$$cont|.root[0].st_y|].b_x["$("$$cont|.root[0].st_x|" +1)"].layout
									equals = 5
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = "$("$$cont|.root[0].st_x|" +1)"
											y = $$cont|.root[0].st_y|
											path_type = 7
										[/value]
									[/set_variables]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = "$("$$cont|.root[0].st_x|" +1)"
											y = $$cont|.root[0].st_y|
											path_type = 9
										[/value]
									[/set_variables]
								[/else]
							[/if]
						[/case]
					[/switch]
					######## ゴール地点のレイアウトで分岐
					[switch]
						variable = $cont|.root[0].en_l
						[case]
							value = 12,17
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].en_x|
									y = $$cont|.root[0].en_y|
									path_type = 11
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 13
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].en_x|
									y = $$cont|.root[0].en_y|
									path_type = 12
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 14
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].en_x|
									y = $$cont|.root[0].en_y|
									path_type = 13
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 18
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].en_x|
									y = $$cont|.root[0].en_y|
									path_type = 14
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 19
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].en_x|
									y = $$cont|.root[0].en_y|
									path_type = 15
								[/value]
							[/set_variables]
						[/case]
						####################################### 問題のある場所
						#######################################
						#######################################
						[case]
							value = 23
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].en_x|
									y = $$cont|.root[0].en_y|
									path_type = 0
								[/value]
							[/set_variables]
							[if]
								[variable]
									name = $cont|.b_y[$$cont|.root[0].en_y|].b_x["$("$$cont|.root[0].en_x|" -1)"].layout
									equals = 13
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = "$("$$cont|.root[0].en_x|" -1)"
											y = $$cont|.root[0].en_y|
											path_type = 12
										[/value]
									[/set_variables]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = "$("$$cont|.root[0].en_x|" -1)"
											y = $$cont|.root[0].en_y|
											path_type = 14
										[/value]
									[/set_variables]
								[/else]
							[/if]
						[/case]
					[/switch]
				[/case]
				
				[case]
					value = east
					######## スタート地点のレイアウトで分岐
					[switch]
						variable = $cont|.root[0].st_l
						[case]
							value = 12,17
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].st_x|
									y = $$cont|.root[0].st_y|
									path_type = 11
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 13
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].st_x|
									y = $$cont|.root[0].st_y|
									path_type = 12
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 14
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].st_x|
									y = $$cont|.root[0].st_y|
									path_type = 13
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 18
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].st_x|
									y = $$cont|.root[0].st_y|
									path_type = 14
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 19
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].st_x|
									y = $$cont|.root[0].st_y|
									path_type = 15
								[/value]
							[/set_variables]
						[/case]
						####################################### 問題のある場所
						#######################################
						#######################################
						[case]
							value = 23
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].st_x|
									y = $$cont|.root[0].st_y|
									path_type = 0
								[/value]
							[/set_variables]
							[if]
								[variable]
									name = $cont|.b_y[$$cont|.root[0].st_y|].b_x["$("$$cont|.root[0].st_x|" -1)"].layout
									equals = 13
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = "$("$$cont|.root[0].st_x|" -1)"
											y = $$cont|.root[0].st_y|
											path_type = 12
										[/value]
									[/set_variables]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = "$("$$cont|.root[0].st_x|" -1)"
											y = $$cont|.root[0].st_y|
											path_type = 14
										[/value]
									[/set_variables]
								[/else]
							[/if]
						[/case]
						
					[/switch]
					######## ゴール地点のレイアウトで分岐
					[switch]
						variable = $cont|.root[0].en_l
						[case]
							value = 4
							##### 通路コンテナ番号の更新
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							##### 付け足し用通路データ
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].en_x|
									y = $$cont|.root[0].en_y|
									path_type = 6
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 5
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].en_x|
									y = $$cont|.root[0].en_y|
									path_type = 7
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 6
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].en_x|
									y = $$cont|.root[0].en_y|
									path_type = 8
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 9
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].en_x|
									y = $$cont|.root[0].en_y|
									path_type = 9
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 10
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].en_x|
									y = $$cont|.root[0].en_y|
									path_type = 10
								[/value]
							[/set_variables]
						[/case]
						####################################### 問題のある場所
						#######################################
						#######################################
						[case]
							value = 23
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].en_x|
									y = $$cont|.root[0].en_y|
									path_type = 0
								[/value]
							[/set_variables]
							[if]
								[variable]
									name = $cont|.b_y[$$cont|.root[0].en_y|].b_x["$("$$cont|.root[0].en_x|" +1)"].layout
									equals = 5
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = "$("$$cont|.root[0].en_x|" +1)"
											y = $$cont|.root[0].en_y|
											path_type = 7
										[/value]
									[/set_variables]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = "$("$$cont|.root[0].en_x|" +1)"
											y = $$cont|.root[0].en_y|
											path_type = 9
										[/value]
									[/set_variables]
								[/else]
							[/if]
						[/case]
					[/switch]
					
				[/case]
				[case]
					value = north
					######## スタート地点のレイアウトで分岐
					[switch]
						variable = $cont|.root[0].st_l
						[case]
							value = 3,12,21
							##### 通路コンテナ番号の更新
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							##### 付け足し用通路データ
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].st_x|
									y = $$cont|.root[0].st_y|
									path_type = 16
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 4,13
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].st_x|
									y = $$cont|.root[0].st_y|
									path_type = 17
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 5,14
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].st_x|
									y = $$cont|.root[0].st_y|
									path_type = 18
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 6
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].st_x|
									y = $$cont|.root[0].st_y|
									path_type = 19
								[/value]
							[/set_variables]
						[/case]
						####################################### 問題のある場所
						#######################################
						#######################################
						[case]
							value = 23
							[if]
								[variable]
									name = $cont|.b_y[$$cont|.root[0].st_y|].b_x["$("$$cont|.root[0].st_x|" +1)"].layout
									equals = 5
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = $$cont|.root[0].st_x|
											y = $$cont|.root[0].st_y|
											path_type = 4
										[/value]
									[/set_variables]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = "$("$$cont|.root[0].st_x|" +1)"
											y = $$cont|.root[0].st_y|
											path_type = 7
										[/value]
									[/set_variables]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = $$cont|.root[0].st_x|
											y = $$cont|.root[0].st_y|
											path_type = 2
										[/value]
									[/set_variables]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = "$("$$cont|.root[0].st_x|" -1)"
											y = $$cont|.root[0].st_y|
											path_type = 12
										[/value]
									[/set_variables]
								[/else]
							[/if]
						[/case]
					[/switch]
					######## ゴール地点のレイアウトで分岐
					[switch]
						variable = $cont|.root[0].en_l
						[case]
							value = 7,16,21,22
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].en_x|
									y = $$cont|.root[0].en_y|
									path_type = 20
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 8,17
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].en_x|
									y = $$cont|.root[0].en_y|
									path_type = 21
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 9,18
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].en_x|
									y = $$cont|.root[0].en_y|
									path_type = 22
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 10,19
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].en_x|
									y = $$cont|.root[0].en_y|
									path_type = 23
								[/value]
							[/set_variables]
						[/case]
						####################################### 問題のある場所
						#######################################
						#######################################
						[case]
							value = 23
							[if]
								[variable]
									name = $cont|.b_y[$$cont|.root[0].en_y|].b_x["$("$$cont|.root[0].en_x|" +1)"].layout
									equals = 9
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = $$cont|.root[0].en_x|
											y = $$cont|.root[0].en_y|
											path_type = 5
										[/value]
									[/set_variables]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = "$("$$cont|.root[0].en_x|" +1)"
											y = $$cont|.root[0].en_y|
											path_type = 9
										[/value]
									[/set_variables]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = $$cont|.root[0].en_x|
											y = $$cont|.root[0].en_y|
											path_type = 3
										[/value]
									[/set_variables]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = "$("$$cont|.root[0].en_x|" -1)"
											y = $$cont|.root[0].en_y|
											path_type = 14
										[/value]
									[/set_variables]
								[/else]
							[/if]
						[/case]
					[/switch]
					
				[/case]
				[case]
					value = south
					######## スタート地点のレイアウトで分岐
					[switch]
						variable = $cont|.root[0].st_l
						[case]
							value = 7,16,21,22
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].st_x|
									y = $$cont|.root[0].st_y|
									path_type = 20
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 8,17
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].st_x|
									y = $$cont|.root[0].st_y|
									path_type = 21
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 9,18
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].st_x|
									y = $$cont|.root[0].st_y|
									path_type = 22
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 10,19
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].st_x|
									y = $$cont|.root[0].st_y|
									path_type = 23
								[/value]
							[/set_variables]
						[/case]
						####################################### 問題のある場所
						#######################################
						#######################################
						[case]
							value = 23
							[if]
								[variable]
									name = $cont|.b_y[$$cont|.root[0].st_y|].b_x["$("$$cont|.root[0].st_x|" +1)"].layout
									equals = 9
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = $$cont|.root[0].st_x|
											y = $$cont|.root[0].st_y|
											path_type = 5
										[/value]
									[/set_variables]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = "$("$$cont|.root[0].st_x|" +1)"
											y = $$cont|.root[0].st_y|
											path_type = 9
										[/value]
									[/set_variables]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = $$cont|.root[0].st_x|
											y = $$cont|.root[0].st_y|
											path_type = 3
										[/value]
									[/set_variables]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = "$("$$cont|.root[0].st_x|" -1)"
											y = $$cont|.root[0].st_y|
											path_type = 14
										[/value]
									[/set_variables]
								[/else]
							[/if]
						[/case]
					[/switch]
					######## ゴール地点のレイアウトで分岐
					[switch]
						variable = $cont|.root[0].en_l
						[case]
							value = 3,12,21
							##### 通路コンテナ番号の更新
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							##### 付け足し用通路データ
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].en_x|
									y = $$cont|.root[0].en_y|
									path_type = 16
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 4,13
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].en_x|
									y = $$cont|.root[0].en_y|
									path_type = 17
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 5,14
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].en_x|
									y = $$cont|.root[0].en_y|
									path_type = 18
								[/value]
							[/set_variables]
						[/case]
						[case]
							value = 6
							[set_variable]
								name = $cont|.root[0].turn_num
								add = 1
							[/set_variable]
							[set_variables]
								name = $cont|.root[$$cont|.root[0].turn_num|]
								mode = insert
								[value]
									x = $$cont|.root[0].en_x|
									y = $$cont|.root[0].en_y|
									path_type = 19
								[/value]
							[/set_variables]
						[/case]
						####################################### 問題のある場所
						#######################################
						#######################################
						[case]
							value = 23
							[if]
								[variable]
									name = $cont|.b_y[$$cont|.root[0].en_y|].b_x["$("$$cont|.root[0].en_x|" +1)"].layout
									equals = 5
								[/variable]
								[then]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = $$cont|.root[0].en_x|
											y = $$cont|.root[0].en_y|
											path_type = 4
										[/value]
									[/set_variables]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = "$("$$cont|.root[0].en_x|" +1)"
											y = $$cont|.root[0].en_y|
											path_type = 7
										[/value]
									[/set_variables]
								[/then]
								[else]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = $$cont|.root[0].en_x|
											y = $$cont|.root[0].en_y|
											path_type = 2
										[/value]
									[/set_variables]
									[set_variable]
										name = $cont|.root[0].turn_num
										add = 1
									[/set_variable]
									[set_variables]
										name = $cont|.root[$$cont|.root[0].turn_num|]
										mode = insert
										[value]
											x = "$("$$cont|.root[0].en_x|" -1)"
											y = $$cont|.root[0].en_y|
											path_type = 12
										[/value]
									[/set_variables]
								[/else]
							[/if]
						[/case]
					[/switch]
					
				[/case]
			[/switch]
			
				[/then]
			[/if]
			
		[/do]
	[/for]
	
	###################################################### 通路の描画
	[for]
		variable = i
		start = 1
		end = $map_block.rooms.room_num|
		step = 1
		[do]
			[set_variable]
				name = cont
				value = $cont_$i||
			[/set_variable]
			[for]
				variable = l
				start = 1
				end = $$cont|.root[0].turn_num|
				step = 1
				[do]
				
					[for]
						variable = m
						start = 1
						end = 4
						step = 1
						[do]
							[switch]
								variable = tile_set.pathway[$$cont|.root[$l|].path_type|].x_$m|
								[case]
									value = 1
									[terrain]
										terrain = {PATHWAY}
										x= "$("$$cont|.root[$l|].x|"*4+$m|)"
										y= "$("$$cont|.root[$l|].y|"*4+1)"
									[/terrain]
								[/case]
								[case]
									value = 2
									[terrain]
										terrain = {PATHWAY}
										x= "$("$$cont|.root[$l|].x|"*4+$m|)"
										y= "$("$$cont|.root[$l|].y|"*4+2)"
									[/terrain]
								[/case]
								[case]
									value = 3
									[terrain]
										terrain = {PATHWAY}
										x= "$("$$cont|.root[$l|].x|"*4+$m|)"
										y= "$("$$cont|.root[$l|].y|"*4+3)"
									[/terrain]
								[/case]
								[case]
									value = 4
									[terrain]
										terrain = {PATHWAY}
										x= "$("$$cont|.root[$l|].x|"*4+$m|)"
										y= "$("$$cont|.root[$l|].y|"*4+4)"
									[/terrain]
								[/case]
								[case]
									value = 1_2
									[terrain]
										terrain = {PATHWAY}
										x= "$("$$cont|.root[$l|].x|"*4+$m|)"
										y= "$("$$cont|.root[$l|].y|"*4+1)"
									[/terrain]
									[terrain]
										terrain = {PATHWAY}
										x= "$("$$cont|.root[$l|].x|"*4+$m|)"
										y= "$("$$cont|.root[$l|].y|"*4+2)"
									[/terrain]
								[/case]
								[case]
									value = 1_3
									[for]
										variable = j
										start = 1
										end = 3
										step = 1
										[do]
											[terrain]
												terrain = {PATHWAY}
												x= "$("$$cont|.root[$l|].x|"*4+$m|)"
												y= "$("$$cont|.root[$l|].y|"*4+$j|)"
											[/terrain]
										[/do]
									[/for]
								[/case]
								[case]
									value = 1_4
									[for]
										variable = j
										start = 1
										end = 4
										step = 1
										[do]
											[terrain]
												terrain = {PATHWAY}
												x= "$("$$cont|.root[$l|].x|"*4+$m|)"
												y= "$("$$cont|.root[$l|].y|"*4+$j|)"
											[/terrain]
										[/do]
									[/for]
								[/case]
								[case]
									value = 2_3
									[terrain]
										terrain = {PATHWAY}
										x= "$("$$cont|.root[$l|].x|"*4+$m|)"
										y= "$("$$cont|.root[$l|].y|"*4+2)"
									[/terrain]
									[terrain]
										terrain = {PATHWAY}
										x= "$("$$cont|.root[$l|].x|"*4+$m|)"
										y= "$("$$cont|.root[$l|].y|"*4+3)"
									[/terrain]
								[/case]
								[case]
									value = 2_4
									[for]
										variable = j
										start = 2
										end = 4
										step = 1
										[do]
											[terrain]
												terrain = {PATHWAY}
												x= "$("$$cont|.root[$l|].x|"*4+$m|)"
												y= "$("$$cont|.root[$l|].y|"*4+$j|)"
											[/terrain]
										[/do]
									[/for]
								[/case]
								[case]
									value = 3_4
									[terrain]
										terrain = {PATHWAY}
										x= "$("$$cont|.root[$l|].x|"*4+$m|)"
										y= "$("$$cont|.root[$l|].y|"*4+3)"
									[/terrain]
									[terrain]
										terrain = {PATHWAY}
										x= "$("$$cont|.root[$l|].x|"*4+$m|)"
										y= "$("$$cont|.root[$l|].y|"*4+4)"
									[/terrain]
								[/case]
							[/switch]
						[/do]
					[/for]
				
				[/do]
			[/for]
		[/do]
	[/for]
	
	
		###################################################### 通常処理終了
		[/then]
		[else]
		###################################################### 大部屋作成
			#### 床の描画
			[for]
				variable = i
				start = 5
				end = "$({SIZE_Y}*4)"
				step = 1
				[do]
					[for]
						variable = l
						start = 5
						end = "$({SIZE_X}*4)"
						step = 1
						[do]
							[set_variable]
								name = tile_set.terracode.tile_str
								rand = {ROOM}
							[/set_variable]
							[terrain]
								terrain = "$tile_set.terracode.tile_str|"
								x = "$($map_block.b_y[$i|].b_x[$l|].start_x|+$m|)"
								y = "$($map_block.b_y[$i|].b_x[$l|].start_y|+$j|)"
							[/terrain]
						[/do]
					[/for]
				[/do]
			[/for]
			
			
			
		[/else]
	[/if]
	
	##################################################### 階段の配置
	#####################################################
	#####################################################
	#####################################################
	
	######### 階段タイプと脱出路タイプをマクロで選択する
	{EXIT}
	
	
	
	##################################################### プレイヤーの配置
	[if]
		[variable]
			name = map_block.rooms.room_num
			greater_than = 1
		[/variable]
		
		[then]
	######### 部屋を選ぶ
	[set_variable]
		name = map_block.rooms.player_room
		rand = 1..$map_block.rooms.room_num|
	[/set_variable]
	#### 部屋のパス
	[set_variable]
		name = player_room
		value = $cont_$map_block.rooms.player_room||
	[/set_variable]
	##### 位置を決める
	[switch]
		variable = $player_room|.size_x
		[case]
			value = 1
			[set_variable]
				name = map_block.rooms.player_x
				value = 1
			[/set_variable]
		[/case]
		[case]
			value = 6
			[set_variable]
				name = map_block.rooms.player_x
				rand = 2..4
			[/set_variable]
		[/case]
		[else]
			[set_variable]
				name = map_block.rooms.player_x
				rand = 1..$$player_room|.size_x|
			[/set_variable]
		[/else]
	[/switch]
	[if]
		[variable]
			name = $player_room|.size_y
			not_equals = 1
		[/variable]
		[then]
			[set_variable]
				name = map_block.rooms.player_y
				rand = 1..$$player_room|.size_y|
			[/set_variable]
		[/then]
		[else]
			[set_variable]
				name = map_block.rooms.player_y
				value = 1
			[/set_variable]
		[/else]
	[/if]
	##### プレイヤー配置場所
	[set_variable]
		name = map_block.player_x
		value = "$(("$map_block.rooms.player_x|"+"$$player_room|.x_s|"-1)*4)"
	[/set_variable]
	[set_variable]
		name = map_block.player_y
		value = "$(("$map_block.rooms.player_y|"+"$$player_room|.y_s|"-1)*4)"
	[/set_variable]
		
		[/then]
		[else]
		##################################################### 大部屋プレイヤーの配置
			##### 位置を決める
			[set_variable]
				name = map_block.player_x
				rand = 5.."$({SIZE_X}*4)"
			[/set_variable]
			[set_variable]
				name = map_block.player_y
				rand = 5.."$({SIZE_Y}*4)"
			[/set_variable]
		[/else]
	[/if]
	
	##################################################### ピットの配置
	[if]
		[variable]
			name = map_block.rooms.room_num
			greater_than = 1
		[/variable]
		[then]
			##### 発生させるか決める
			[set_variable]
				name = pit_on
				rand = 1..100,1..80
			[/set_variable]
			[if]
				[variable]
					name = pit_on
					greater_than = 90
				[/variable]
				[then]
					##### 発生
					[set_variable]
						name = map_setting.pit
						value = on
					[/set_variable]
					[set_variable]
						name = map_setting.pit_type
						value = small
					[/set_variable]
					
					##### 一番大きい部屋を選ぶ
					[set_variable]
						name = pit_room
						value = 0
					[/set_variable]
					[for]
						variable = i
						start = 1
						end = $map_block.rooms.room_num|
						step = 1
						[do]
							[if]
								[variable]
									name = $cont_$pit_room||.block
									less_than = $$cont_$i||.block|
								[/variable]
								[then]
									[set_variable]
										name = pit_room
										value = $i|
									[/set_variable]
								[/then]
							[/if]
						[/do]
					[/for]
					##### ピット座標を決める
					[set_variable]
						name = pit_room_x
						value = "$("$$cont_$pit_room||.size_x|"/2)"
					[/set_variable]
					[set_variable]
						name = pit_room_x
						round = floor
					[/set_variable]
					[set_variable]
						name = pit_room_y
						value = "$("$$cont_$pit_room||.size_y|"/2)"
					[/set_variable]
					[set_variable]
						name = pit_room_y
						round = floor
					[/set_variable]
					[set_variable]
						name = map_setting.pit_x
						value = "$("$pit_room_x|"*4+2)"
					[/set_variable]
					[set_variable]
						name = map_setting.pit_y
						value = "$("$pit_room_y|"*4+2)"
					[/set_variable]
				[/then]
				[else]
					[set_variable]
						name = map_setting.pit
						value = off
					[/set_variable]
				[/else]
			[/if]
		[/then]
		[else]
			##### 大部屋の場合
			[set_variable]
				name = map_setting.pit_x
				value = 5.."$({SIZE_X}*4)"
			[/set_variable]
			[set_variable]
				name = map_setting.pit_y
				value = 5.."$({SIZE_Y}*4)"
			[/set_variable]
			[set_variable]
				name = map_setting.pit
				value = on
			[/set_variable]
			[set_variable]
				name = map_setting.pit_type
				value = big
			[/set_variable]
		[/else]
	[/if]
	
	##################################################### 罠の配置
	#### 個数を決める
	[set_variable]
		name = map_setting.trap.trap_num
		rand = 1.."$("$map_setting.depth|"*2)"
	[/set_variable]
	#### 場所を決める
	[for]
		variable = i
		start = 1
		end = $map_setting.trap.trap_num|
		step = 1
		[do]
			[set_variable]
				name = trap_room_x
				value = 0
			[/set_variable]
			[set_variable]
				name = trap_room_y
				value = 0
			[/set_variable]
			[while]
				[variable]
					name = map_block.b_y[$trap_room_y|].b_x[$trap_room_x|].layout
					equals = 23
				[/variable]
				[do]
					[set_variable]
						name = trap_room_x
						rand = 1..{SIZE_X}
					[/set_variable]
					[set_variable]
						name = trap_room_y
						rand = 1..{SIZE_Y}
					[/set_variable]
				[/do]
			[/while]
			[switch]
				variable = map_block.b_y[$trap_room_y|].b_x[$trap_room_x|].layout
				[case]
					value = 1,2,3,4,7,8,9,11,12,13,15,16,17,20,21,22
					[set_variable]
						name = trap_x
						rand = 1..4
					[/set_variable]
				[/case]
				[case]
					value = 5
					[set_variable]
						name = trap_x
						rand = 2..4
					[/set_variable]
				[/case]
				[case]
					value = 6
					[set_variable]
						name = trap_x
						value = 4
					[/set_variable]
				[/case]
				[case]
					value = 10
					[set_variable]
						name = trap_x
						rand = 3,4
					[/set_variable]
				[/case]
				[case]
					value = 14
					[set_variable]
						name = trap_x
						rand = 1,2
					[/set_variable]
				[/case]
				[case]
					value = 18
					[set_variable]
						name = trap_x
						rand = 1..3
					[/set_variable]
				[/case]
				[case]
					value = 19
					[set_variable]
						name = trap_x
						value = 1
					[/set_variable]
				[/case]
			[/switch]
			[switch]
				variable = tile_set.layout[$map_block.b_y[$trap_room_y|].b_x[$trap_room_x|].layout|].x_$trap_x|
				[case]
					value = 1,2,3,4
					[set_variable]
						name = trap_y
						value = $tile_set.layout[$map_block.b_y[$trap_room_y|].b_x[$trap_room_x|].layout|].x_$trap_x||
					[/set_variable]
				[/case]
				[case]
					value = 1_4
					[set_variable]
						name = trap_y
						rand = 1..4
					[/set_variable]
				[/case]
				[case]
					value = 1_3
					[set_variable]
						name = trap_y
						rand = 1..3
					[/set_variable]
				[/case]
				[case]
					value = 1_2
					[set_variable]
						name = trap_y
						rand = 1,2
					[/set_variable]
				[/case]
				[case]
					value = 2_4
					[set_variable]
						name = trap_y
						rand = 2..4
					[/set_variable]
				[/case]
				[case]
					value = 2_3
					[set_variable]
						name = trap_y
						rand = 2,3
					[/set_variable]
				[/case]
				[case]
					value = 3_4
					[set_variable]
						name = trap_y
						rand = 3,4
					[/set_variable]
				[/case]
			[/switch]
			[set_variable]
				name = type
				rand = $map_setting.trap[0].trap_type|
			[/set_variable]
			[set_variables]
				name = map_setting.trap[$i|]
				mode = insert
				[value]
					trap_x = "$("$trap_room_x|"*4+"$trap_x|")"
					trap_y = "$("$trap_room_y|"*4+"$trap_y|")"
					trap_type = $type|
				[/value]
			[/set_variables]
		[/do]
	[/for]
	[set_variable]
		name = map_setting.trap[0].t_x
		[join]
			variable = map_setting.trap
			key = trap_x
			separator = ","
			remove_empty = yes
		[/join]
	[/set_variable]
	[set_variable]
		name = map_setting.trap[0].t_y
		[join]
			variable = map_setting.trap
			key = trap_y
			separator = ","
			remove_empty = yes
		[/join]
	[/set_variable]
	##### 変数整理
	[clear_variable]
		name = trap_room_x,trap_room_y,trap_x,trap_y,type
	[/clear_variable]
	
	##################################################### アイテムの配置
	#### 個数を決める
	[set_variable]
		name = map_setting.item.item_num
		rand = 3..8
	[/set_variable]
	#### 場所を決める
	[for]
		variable = i
		start = 1
		end = $map_setting.item.item_num|
		step = 1
		[do]
			[set_variable]
				name = trap_room_x
				value = 0
			[/set_variable]
			[set_variable]
				name = trap_room_y
				value = 0
			[/set_variable]
			[while]
				[variable]
					name = map_block.b_y[$trap_room_y|].b_x[$trap_room_x|].layout
					equals = 23
				[/variable]
				[do]
					[set_variable]
						name = trap_room_x
						rand = 1..{SIZE_X}
					[/set_variable]
					[set_variable]
						name = trap_room_y
						rand = 1..{SIZE_Y}
					[/set_variable]
				[/do]
			[/while]
			[switch]
				variable = map_block.b_y[$trap_room_y|].b_x[$trap_room_x|].layout
				[case]
					value = 1,2,3,4,7,8,9,11,12,13,15,16,17,20,21,22
					[set_variable]
						name = trap_x
						rand = 1..4
					[/set_variable]
				[/case]
				[case]
					value = 5
					[set_variable]
						name = trap_x
						rand = 2..4
					[/set_variable]
				[/case]
				[case]
					value = 6
					[set_variable]
						name = trap_x
						value = 4
					[/set_variable]
				[/case]
				[case]
					value = 10
					[set_variable]
						name = trap_x
						rand = 3,4
					[/set_variable]
				[/case]
				[case]
					value = 14
					[set_variable]
						name = trap_x
						rand = 1,2
					[/set_variable]
				[/case]
				[case]
					value = 18
					[set_variable]
						name = trap_x
						rand = 1..3
					[/set_variable]
				[/case]
				[case]
					value = 19
					[set_variable]
						name = trap_x
						value = 1
					[/set_variable]
				[/case]
			[/switch]
			[switch]
				variable = tile_set.layout[$map_block.b_y[$trap_room_y|].b_x[$trap_room_x|].layout|].x_$trap_x|
				[case]
					value = 1,2,3,4
					[set_variable]
						name = trap_y
						value = $tile_set.layout[$map_block.b_y[$trap_room_y|].b_x[$trap_room_x|].layout|].x_$trap_x||
					[/set_variable]
				[/case]
				[case]
					value = 1_4
					[set_variable]
						name = trap_y
						rand = 1..4
					[/set_variable]
				[/case]
				[case]
					value = 1_3
					[set_variable]
						name = trap_y
						rand = 1..3
					[/set_variable]
				[/case]
				[case]
					value = 1_2
					[set_variable]
						name = trap_y
						rand = 1,2
					[/set_variable]
				[/case]
				[case]
					value = 2_4
					[set_variable]
						name = trap_y
						rand = 2..4
					[/set_variable]
				[/case]
				[case]
					value = 2_3
					[set_variable]
						name = trap_y
						rand = 2,3
					[/set_variable]
				[/case]
				[case]
					value = 3_4
					[set_variable]
						name = trap_y
						rand = 3,4
					[/set_variable]
				[/case]
			[/switch]
			[set_variables]
				name = map_setting.item[$i|]
				mode = insert
				[value]
					trap_x = "$("$trap_room_x|"*4+"$trap_x|")"
					trap_y = "$("$trap_room_y|"*4+"$trap_y|")"
				[/value]
			[/set_variables]
		[/do]
	[/for]
	
	[set_variable]
		name = map_setting.item[0].item_x
		[join]
			variable = map_setting.item
			key = trap_x
			separator = ","
			remove_empty = yes
		[/join]
	[/set_variable]
	[set_variable]
		name = map_setting.item[0].item_y
		[join]
			variable = map_setting.item
			key = trap_y
			separator = ","
			remove_empty = yes
		[/join]
	[/set_variable]
	
	##### 変数整理
	[clear_variable]
		name = trap_room_x,trap_room_y,trap_x,trap_y
	[/clear_variable]
	
	##################################################### 敵ユニットの配置
	#### 個数を決める
	[set_variable]
		name = map_setting.enemy.portal
		rand = 4..8
	[/set_variable]
	#### 場所を決める
	[for]
		variable = i
		start = 1
		end = $map_setting.enemy.portal|
		step = 1
		[do]
			[set_variable]
				name = trap_room_x
				value = 0
			[/set_variable]
			[set_variable]
				name = trap_room_y
				value = 0
			[/set_variable]
			[while]
				[variable]
					name = map_block.b_y[$trap_room_y|].b_x[$trap_room_x|].layout
					equals = 23
				[/variable]
				[do]
					[set_variable]
						name = trap_room_x
						rand = 1..{SIZE_X}
					[/set_variable]
					[set_variable]
						name = trap_room_y
						rand = 1..{SIZE_Y}
					[/set_variable]
				[/do]
			[/while]
			[set_variables]
				name = map_setting.enemy[$i|]
				mode = insert
				[value]
					enemy_x = "$("$trap_room_x|"*4+2)"
					enemy_y = "$("$trap_room_y|"*4+2)"
					turn = 0
				[/value]
			[/set_variables]
		[/do]
	[/for]
	##### 変数整理
	[clear_variable]
		name = trap_room_x,trap_room_y
	[/clear_variable]
	
	##################################################### 変数の整理
	[set_variables]
		name = map_setting
		mode = merge
		[value]
			#### プレイヤー初期位置
			player_x = $map_block.player_x|
			player_y = $map_block.player_y|
			#### 出口の場所
			exit_x = $map_block.stairs_x|
			exit_y = $map_block.stairs_y|
		[/value]
	[/set_variables]
	[for]
		variable = i
		start = 1
		end = $map_block.rooms.room_num|
		step = 1
		[do]
			[clear_variable]
				name = cont_$i|
			[/clear_variable]
		[/do]
	[/for]
	[clear_variable]
		name = tile_set,cont,part,pit_on,player_room,map_block,dice,stairs_room,terracode
	[/clear_variable]
#enddef
